<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Openzeppelin笔记 | NeWive&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="通过继承的方式使用12345678910pragma solidity ^0.8.13;import &quot;@openzeppin&#x2F;contracts&#x2F;access&#x2F;AccessControl.sol&quot;;contract ModifierAccessControl is AccessControl &amp;#123;	function revokeRole(bytes32 role, a">
<meta property="og:type" content="article">
<meta property="og:title" content="Openzeppelin笔记">
<meta property="og:url" content="https://newive.github.io/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="NeWive&#39;s Blog">
<meta property="og:description" content="通过继承的方式使用12345678910pragma solidity ^0.8.13;import &quot;@openzeppin&#x2F;contracts&#x2F;access&#x2F;AccessControl.sol&quot;;contract ModifierAccessControl is AccessControl &amp;#123;	function revokeRole(bytes32 role, a">
<meta property="og:locale">
<meta property="article:published_time" content="2023-05-27T01:39:38.000Z">
<meta property="article:modified_time" content="2023-05-27T01:40:13.543Z">
<meta property="article:author" content="NeWive">
<meta property="article:tag" content="solidity">
<meta property="article:tag" content="openzeppelin">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="NeWive's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">NeWive&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">NeWive的鸽子窝</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://newive.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Openzeppelin笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2023-05-27T01:39:38.000Z" itemprop="datePublished">2023-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Openzeppelin笔记
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="通过继承的方式使用"><a href="#通过继承的方式使用" class="headerlink" title="通过继承的方式使用"></a>通过继承的方式使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ModifierAccessControl is AccessControl &#123;</span><br><span class="line">	function revokeRole(bytes32 role, address account) public override &#123;</span><br><span class="line">		require(role != DEFEAULT_ADMIN_ROLE, &quot;ModifierdAccessControl: Cannot revoke def&quot;);</span><br><span class="line">		super.revokeRule(role, account);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用hooks"><a href="#使用hooks" class="headerlink" title="使用hooks"></a>使用hooks</h2><p>使用 <code>_beforeTokenTranser</code> hook拓展ERC20中的 <code>IERC721Receiver</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ERC20WithSafeTranser is ERC20 &#123;</span><br><span class="line">	function _beforeTOkenTransfer(address from, address to, uint256 amount) internal virtual override &#123;</span><br><span class="line">	super._beforeTokenTranser(from, to, amount);</span><br><span class="line">	require(_validRecipient(to), &quot;ERC20WithSafeTransfer: invalid recipient&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Hook的规则：</p>
<ol>
<li>当重写hook时对新的函数添加 <code>virtual</code> 属性以便于后续子合约对其拓展。</li>
<li>总是通过 <code>super</code> 的方式调用父hook以确保在继承树中的所有hook都被调用。</li>
</ol>
<h2 id="upgradeability"><a href="#upgradeability" class="headerlink" title="upgradeability"></a>upgradeability</h2><p>可升级的合约：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @openzeppelin/contracts-upgradeable</span><br></pre></td></tr></table></figure>

<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><h3 id="合约的所有权"><a href="#合约的所有权" class="headerlink" title="合约的所有权"></a>合约的所有权</h3><p><code>Ownable.sol</code> 提供对判定合约函数所有者相关的API。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contracts/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyContract is Ownable &#123;</span><br><span class="line">	function normalThing() public &#123;</span><br><span class="line">		//...</span><br><span class="line">	&#125;</span><br><span class="line">	function specialThing() public onlyOwner &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Ownable</code>合约默认部署合约者作为合约的所有者。同时该合约还可以</p>
<ul>
<li><code>transferOwnership</code>: 修改合约所有人</li>
<li><code>renounceOwnership</code>: 当前所有人放弃所有权</li>
</ul>
<p>注意移除所有者之后<code>onlyOwner</code>装饰器将不可用。</p>
<h3 id="基于角色的访问控制"><a href="#基于角色的访问控制" class="headerlink" title="基于角色的访问控制"></a>基于角色的访问控制</h3><p><code>AccessControl.sol</code> 提供基于角色的访问控制相关的API。</p>
<p>通过创建一个新的角色标识符 <code>role identifier</code> 来进行访问控制。一般 <code>role identifier</code> 是一段通过keccak256生成的哈希。</p>
<p>通过 <code>_grantRole</code> 创建角色。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	constructor(address minter) ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(MINTER_ROLE, minter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public &#123;</span><br><span class="line">		require(hasRole(MINTER_ROLE, msg.sender), &quot;Caller is not a minter&quot;);</span><br><span class="line">		_mint(to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>onlyRole</code> 装饰器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	bytes32 public constant BURNER_ROLE = keccak256(&quot;BURNER&quot;);</span><br><span class="line">	constructor(address minter, address burner) ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(MINTER_ROLE, minter);</span><br><span class="line">		_grantRole(BURNER_ROLE, burner);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public onlyRole(MINTER_ROLE) &#123;</span><br><span class="line">		_mint(to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function burn(address from, uint256 amount) public onlyRole(BURNER_ROLE) &#123;</span><br><span class="line">		_burn(from, amount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="管理角色权限"><a href="#管理角色权限" class="headerlink" title="管理角色权限"></a>管理角色权限</h3><p>默认情况下，具有角色的帐户不能授予它或从其他帐户中撤销它。为了动态的管理角色权限需要一个角色管理员(role admin)。</p>
<p>每个角色都有一个相关联的管理员角色用来授权调用 <code>_grantRole</code>与 <code>_revokeRole</code>。<code>AccessControl.sol</code> 具有一个特殊的role <code>DEFAULT_ADMIN_ROLE</code>以作为所有角色的默认管理员角色，可以通过调用 <code>_setRoleAdmin</code> 修改管理员角色。</p>
<p>但是 <code>DEFAULT_ADMIN_ROLE</code> 因为也是自己的管理员所以具有风险。可以使用 <code>AccessControlDefaultAdminRules</code> 来对管理员角色添加强制安全措施。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	bytes32 public constant BURNER_ROLE = keccak256(&quot;BURNER&quot;);</span><br><span class="line">	constructor() ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(DEFAULT_ADMIN_ROLE, msg.sender);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public onlyRole(MINTER_ROLE) &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function burn(address from, uint256 amount) public onlyRole(BURNER_ROLE) &#123;</span><br><span class="line">        _burn(from, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于DEFAULT_ADMIN_RULE被设置成为 <code>msg.sender</code>，该账户可以调用 <code>grantRole</code> 来授予别的账户以角色。</p>
<h3 id="遍历特权角色"><a href="#遍历特权角色" class="headerlink" title="遍历特权角色"></a>遍历特权角色</h3><p><code>AccessControl.sol</code> 使用 <code>EnumerableSet</code> 来保存角色信息，可以通过 <code>getRoleMemberCount</code> 来获取特权角色账户的数量。通过 <code>getRoleMember</code>来获取每一位角色。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> minterCount = <span class="keyword">await</span> myToken.<span class="title function_">getRoleMemberCount</span>(<span class="variable constant_">MINTER_ROLE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> members = [];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; minterCount; ++i) &#123;</span><br><span class="line">    members.<span class="title function_">push</span>(<span class="keyword">await</span> myToken.<span class="title function_">getRoleMember</span>(<span class="variable constant_">MINTER_ROLE</span>, i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="延迟操作-Delayed-Operation"><a href="#延迟操作-Delayed-Operation" class="headerlink" title="延迟操作(Delayed Operation)"></a>延迟操作(Delayed Operation)</h2><p>访问控制无法防止内部管理员搞事，因此可以使用 <code>TimelockController</code>。</p>
<p><code>TimelockController</code> 是一个由提议者<code>proposers</code>和执行者<code>executors</code>管理的代理。当设置好管理员后它确保提议者下令进行的任何维护操作都可能会延迟。这个延迟为合约的用户提供时间确保维护操作的合理性。</p>
<p>默认情况下部署合约的地址为 <code>TimelockController</code> 在时间锁上的管理员。这个角色授予任命proposer、executor和其他管理员的权利。</p>
<p><code>TimelockController</code> 需要至少任命一个proposer和一个executor。这些角色可以是相同的账户。同时角色 <code>ADMIN_ROLE</code>、  <code>PROPOSER_ROLE</code>、<code>EXECUTOR_ROLE</code> 基于<code>AccessControl</code> 实现。</p>
<h2 id="合约的标准"><a href="#合约的标准" class="headerlink" title="合约的标准"></a>合约的标准</h2><ul>
<li>ERC20: 同质化资源的token标准</li>
<li>ERC721: 非同质化token(NFT)的标准</li>
<li>ERC777: 更丰富的同质化token标准</li>
</ul>
<h2 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h2><p>符合ERC20的token主要用于交换货币、投票选举等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contract/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GLDToken is ERC20 &#123;</span><br><span class="line">	constructor(uint256 initialSupply) ERC20(&quot;Gold&quot;, &quot;GLD&quot;) &#123;</span><br><span class="line">		_mint(msg.sender, initialSupply);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ERC721"><a href="#ERC721" class="headerlink" title="ERC721"></a>ERC721</h2><p>ERC721是代表NFT所有权的一个标准。</p>
<h3 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h3><p>使用ERC721处理游戏中的物品。当一个物品要奖励给一个玩家时，它会被进行挖矿获取token并发送给玩家。玩家可以自由的保管这些token或者是与他人进行交易。需要注意的是任何人都可以调用 <code>awardItem</code> 来挖掘物品，为了约束这一行为需要增加访问控制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contract/token/ERC721/extensions/ERC721URIStorage.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/utils/Counters.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GameItem is ERC721URIStorage &#123;</span><br><span class="line">	using Counters for Counters.Counter;</span><br><span class="line">	Counters.Counter private _tokenIds;</span><br><span class="line">	</span><br><span class="line">	constructor() ERC721(&quot;GameItem&quot;, &quot;ITM&quot;) &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function awardItem(address player, string memory tokenURI) &#123;</span><br><span class="line">		uint256 newItemId = _tokenIds.current();</span><br><span class="line">		_mint(player, newItemId);</span><br><span class="line">		_setTokenURI(newItemId, tokenURI);</span><br><span class="line">		_tokenIds.increment();</span><br><span class="line">		return newItemId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC721URIStorage</code>合约是ERC721的一个实现，包含元数据标准扩展 <code>IERC721Metadata</code> 和一个关于每个令牌元数据的机制。使用 <code>_setTokenURI</code>保存一个物品的元数据。</p>
<p>需要注意的是ERC721的token不可再分割，且是独一无二的。</p>
<h2 id="链上治理-On-Chain-Governance"><a href="#链上治理-On-Chain-Governance" class="headerlink" title="链上治理(On-Chain Governance)"></a>链上治理(On-Chain Governance)</h2><p>治理协议通常以一个特殊目的的合约实现，称为 <code>Governor</code>。</p>
<h3 id="样例-1"><a href="#样例-1" class="headerlink" title="样例"></a>样例</h3><h4 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h4><p>在治理协议的构建中每个账户的选举权利会由一个ERC20 Token决定。这个token必须实现<code>ERC20Votes</code>拓展。这个拓展会持续追踪历史余额以便投票权是从过去的快照而不是当前余额中检索的，这是一个对防止多次选举的重要保护。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, ERC20Permit, ERC20Votes &#123;</span><br><span class="line">	constructor() ERC20(&quot;MyToken&quot;, &quot;MTK&quot;) ERC20Permit(&quot;MyToken&quot;) &#123;&#125;</span><br><span class="line">	</span><br><span class="line">	function _afterTokenTransfer(address from, address to, uint256 amount) internal override(ERC20m ERC20Votes) &#123;</span><br><span class="line">		super._afterTokenTransfer(from, to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">	    function _mint(address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._burn(account, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您的项目已经有一个不包含 <code>ERC20Votes</code> 且不可升级的实时令牌，您可以使用 <code>ERC20Wrapper</code> 将其包装在治理token中。这将允许token持有者通过一对一包装他们的token来参与治理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Wrapper.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, ERC20Permit, ERC20Votes, ERC20Wrapper &#123;</span><br><span class="line">    constructor(IERC20 wrappedToken)</span><br><span class="line">        ERC20(&quot;MyToken&quot;, &quot;MTK&quot;)</span><br><span class="line">        ERC20Permit(&quot;MyToken&quot;)</span><br><span class="line">        ERC20Wrapper(wrappedToken)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // The functions below are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _afterTokenTransfer(address from, address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._afterTokenTransfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._burn(account, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：目前 OpenZeppelin 合约中唯一可用的其他投票权来源是 ERC721Votes。</p>
<p>不提供此功能的 ERC721 代币可以使用 ERC721Votes 和 ERC721Wrapper 的组合包装成投票代币。</p>
</blockquote>
<h4 id="Governor"><a href="#Governor" class="headerlink" title="Governor"></a>Governor</h4><p>考虑以下问题</p>
<ul>
<li><p>如何决定选举权力</p>
<blockquote>
<p>使用 GovernorVotes模块，该模块连接到 IVotes 实例，以根据提案激活时账户持有的代币余额来确定账户的投票权。</p>
<p>这个模块要求一个地址的token作为构造函数的参数。</p>
</blockquote>
</li>
<li><p>需要多少选举者才合法</p>
<blockquote>
<p>使用 GovernorVotesQuorumFraction模块，与ERC20Votes一起将人数定义为一个检索提案投票权的区块总供应量的百分比。</p>
</blockquote>
</li>
<li><p>人在投票时有什么选项，这些票是如何被计数的</p>
<blockquote>
<p>使用 GovernorCountingSimple模块提供选项，包括 <code>For</code>, <code>Against</code>, <code>Abstain</code>。只有 <code>For</code>, <code>Abstain</code> 被计入人数。</p>
</blockquote>
</li>
<li><p>用什么类型的token作为票</p>
</li>
</ul>
<p>同时Governor还需要确定几个参数</p>
<blockquote>
<p>These parameters are specified in the unit defined in the token’s clock. Assuming the token uses block numbers, and assuming block time of around 12 seconds, we will have set votingDelay &#x3D; 1 day &#x3D; 7200 blocks, and votingPeriod &#x3D; 1 week &#x3D; 50400 blocks.</p>
</blockquote>
<ul>
<li><p>votingDelay: 在创建提议后多长时间投票权确定</p>
<blockquote>
<p>ex: votingDelay &#x3D; 1 day &#x3D; 7200 blocks</p>
</blockquote>
</li>
<li><p>votingPeriod: 提议的投票持续多长时间</p>
<blockquote>
<p>ex: votingPeriod &#x3D; 1 week &#x3D; 50400 blocks.</p>
</blockquote>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.2;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/governance/Governor.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/compatibility/GovernorCompatibilityBravo.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorVotes.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorVotesQuorumFraction.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorTimelockControl.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyGovernor is Governor, GovernorCompatibilityBravo, GovernorVotes, GovernorVotesQuorumFraction, GovernorTimelockControl &#123;</span><br><span class="line">    constructor(IVotes _token, TimelockController _timelock)</span><br><span class="line">        Governor(&quot;MyGovernor&quot;)</span><br><span class="line">        GovernorVotes(_token)</span><br><span class="line">        GovernorVotesQuorumFraction(4)</span><br><span class="line">        GovernorTimelockControl(_timelock)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function votingDelay() public pure override returns (uint256) &#123;</span><br><span class="line">        return 7200; // 1 day</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function votingPeriod() public pure override returns (uint256) &#123;</span><br><span class="line">        return 50400; // 1 week</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposalThreshold() public pure override returns (uint256) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The functions below are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function state(uint256 proposalId)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        override(Governor, IGovernor, GovernorTimelockControl)</span><br><span class="line">        returns (ProposalState)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.state(proposalId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function propose(address[] memory targets, uint256[] memory values, bytes[] memory calldatas, string memory description)</span><br><span class="line">        public</span><br><span class="line">        override(Governor, GovernorCompatibilityBravo, IGovernor)</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.propose(targets, values, calldatas, description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _execute(uint256 proposalId, address[] memory targets, uint256[] memory values, bytes[] memory calldatas, bytes32 descriptionHash)</span><br><span class="line">        internal</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">    &#123;</span><br><span class="line">        super._execute(proposalId, targets, values, calldatas, descriptionHash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _cancel(address[] memory targets, uint256[] memory values, bytes[] memory calldatas, bytes32 descriptionHash)</span><br><span class="line">        internal</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return super._cancel(targets, values, calldatas, descriptionHash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _executor()</span><br><span class="line">        internal</span><br><span class="line">        view</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">        returns (address)</span><br><span class="line">    &#123;</span><br><span class="line">        return super._executor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function supportsInterface(bytes4 interfaceId)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        override(Governor, IERC165, GovernorTimelockControl)</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.supportsInterface(interfaceId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Timelock"><a href="#Timelock" class="headerlink" title="Timelock"></a>Timelock</h4><blockquote>
<p>注意，当使用Timelock时，是Timelock执行决议，因此Timelock合约拥有资金、所有权和对角色访问控制权。</p>
</blockquote>
<p>Timelock需要使用AccessControl设置角色。</p>
<ul>
<li><code>Proposer</code>：控制排队操作，且必须唯一</li>
<li><code>Executor</code>：控制执行已经存在且可行的操作，可以将之设置为0地址以便任何人执行操作。</li>
<li><code>Admin</code>：授予和撤销上述两个角色，默认会将Timelock自身设置为Admin</li>
</ul>
<h2 id="ERC-721-API"><a href="#ERC-721-API" class="headerlink" title="ERC 721 API"></a>ERC 721 API</h2><p>EIC制定了四个接口：</p>
<ul>
<li><p>IERC721: 在所有相关接口中包含的核心功能</p>
</li>
<li><p>IERC721Metadata: 增加名称、标志和token URI的科学拓展，常用</p>
</li>
<li><p>IERC721Enumerable: 允许遍历链上的token，因为消耗大量gas不常用</p>
</li>
<li><p>IERC721Receiver: 如果想要通过 <code>safeTransferFrom</code> 接收token则必须实现的接口</p>
</li>
<li><p>ERC721Consecutive</p>
</li>
<li><p>ERC721URIStorage: 一种更灵活但是开销更大的存储元数据的方法</p>
</li>
<li><p>ERC721Votes</p>
</li>
<li><p>ERC721Royalty</p>
</li>
<li><p>ERC721Pausable</p>
</li>
<li><p>ERC721Burnable</p>
</li>
<li><p>ERC721Wrapper: 用于创建由另一个 ERC721 支持的 ERC721 的包装器，具有存款和取款方法。与 ERC721Votes 结合使用很有用。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/" data-id="cli5d2ofy000x0ohk7h49fgoi" data-title="Openzeppelin笔记" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openzeppelin/" rel="tag">openzeppelin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">Hardhat笔记</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ERC721/" rel="tag">ERC721</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFT/" rel="tag">NFT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alchemy/" rel="tag">alchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openzeppelin/" rel="tag">openzeppelin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3js/" rel="tag">web3js</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ERC721/" style="font-size: 10px;">ERC721</a> <a href="/tags/NFT/" style="font-size: 13.33px;">NFT</a> <a href="/tags/Smart-Contract/" style="font-size: 20px;">Smart Contract</a> <a href="/tags/Solidity/" style="font-size: 16.67px;">Solidity</a> <a href="/tags/alchemy/" style="font-size: 10px;">alchemy</a> <a href="/tags/hardhat/" style="font-size: 13.33px;">hardhat</a> <a href="/tags/openzeppelin/" style="font-size: 10px;">openzeppelin</a> <a href="/tags/solidity/" style="font-size: 13.33px;">solidity</a> <a href="/tags/web3js/" style="font-size: 10px;">web3js</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/">Openzeppelin笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/">Hardhat笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/">ERC721简易项目开发Demo</a>
          </li>
        
          <li>
            <a href="/2023/05/19/ERC721/">ERC721</a>
          </li>
        
          <li>
            <a href="/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">Solidity智能合约基本概念</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 NeWive<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>