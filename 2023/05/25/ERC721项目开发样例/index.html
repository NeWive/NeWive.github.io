<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ERC721简易项目开发Demo | NeWive&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Overview整个项目涉及以下几个部分：  hardhat: 用于部署与测试合约 web3js: 用于与合约交互 alchemy: 提供apiKey以及部分常用的查询API solidity: 编写合约  项目框架目录结构 contracts: 合约源文件 test: 合约测试脚本 scripts: 部署以及合约交互脚本  配置 hardhat.config.ts: hardhat 配置 con">
<meta property="og:type" content="article">
<meta property="og:title" content="ERC721简易项目开发Demo">
<meta property="og:url" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/index.html">
<meta property="og:site_name" content="NeWive&#39;s Blog">
<meta property="og:description" content="Overview整个项目涉及以下几个部分：  hardhat: 用于部署与测试合约 web3js: 用于与合约交互 alchemy: 提供apiKey以及部分常用的查询API solidity: 编写合约  项目框架目录结构 contracts: 合约源文件 test: 合约测试脚本 scripts: 部署以及合约交互脚本  配置 hardhat.config.ts: hardhat 配置 con">
<meta property="og:locale">
<meta property="og:image" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_1.png">
<meta property="og:image" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_2.png">
<meta property="og:image" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/test_1.png">
<meta property="og:image" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/hardhat_1.png">
<meta property="article:published_time" content="2023-05-25T15:11:11.000Z">
<meta property="article:modified_time" content="2023-05-27T01:34:34.083Z">
<meta property="article:author" content="NeWive">
<meta property="article:tag" content="ERC721">
<meta property="article:tag" content="hardhat">
<meta property="article:tag" content="solidity">
<meta property="article:tag" content="alchemy">
<meta property="article:tag" content="web3js">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_1.png">
  
    <link rel="alternate" href="/atom.xml" title="NeWive's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">NeWive&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">NeWive的鸽子窝</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://newive.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-ERC721项目开发样例" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/" class="article-date">
  <time class="dt-published" datetime="2023-05-25T15:11:11.000Z" itemprop="datePublished">2023-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ERC721简易项目开发Demo
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>整个项目涉及以下几个部分：</p>
<ul>
<li>hardhat: 用于部署与测试合约</li>
<li>web3js: 用于与合约交互</li>
<li>alchemy: 提供apiKey以及部分常用的查询API</li>
<li>solidity: 编写合约</li>
</ul>
<h2 id="项目框架"><a href="#项目框架" class="headerlink" title="项目框架"></a>项目框架</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><ul>
<li><code>contracts</code>: 合约源文件</li>
<li><code>test</code>: 合约测试脚本</li>
<li><code>scripts</code>: 部署以及合约交互脚本</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li><code>hardhat.config.ts</code>: hardhat 配置</li>
<li><code>config.json</code>: 其他配置</li>
</ul>
<h3 id="涉及第三方库"><a href="#涉及第三方库" class="headerlink" title="涉及第三方库"></a>涉及第三方库</h3><ul>
<li><code>@openzeppelin/contracts</code></li>
<li><code>hardhat</code></li>
<li><code>@nomicfoundation/hardhat-toolbox</code></li>
<li><code>@nomicfoundation/hardhat-chai-matchers</code></li>
<li><code>chai</code></li>
<li><code>web3</code></li>
<li><code>@nomiclabs/hardhat-ethers</code></li>
<li><code>ethers@^5.0.0</code></li>
</ul>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="config-json"><a href="#config-json" class="headerlink" title="config.json"></a><code>config.json</code></h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;APIKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;privateKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0x48c5c054fee936c953864af7e879fa7fafec9648b4466d4e67e0d58d3d748f0a&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;publicKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0x1f7D4B464dfde59A11A362ee8d094a6FA817f1ca&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;alchemyHTTPURL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://eth-sepolia.g.alchemy.com/v2/pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contractName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NFT&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contractAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;networkName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sepolia&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A ERC721-NFT Demo of NeWive&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="hardhat-config-ts"><a href="#hardhat-config-ts" class="headerlink" title="hardhat.config.ts"></a><code>hardhat.config.ts</code></h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HardhatUserConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;hardhat/config&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;./config.json&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入插件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-toolbox&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomiclabs/hardhat-ethers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-chai-matchers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认网络是localhost，无需额外配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">hardhatUserConfig</span>: <span class="title class_">HardhatUserConfig</span> = &#123;</span><br><span class="line">    <span class="attr">solidity</span>: <span class="string">&quot;0.8.18&quot;</span>,</span><br><span class="line">    <span class="attr">networks</span>: &#123;</span><br><span class="line">        <span class="string">&quot;sepolia&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">url</span>: config.<span class="property">alchemyHTTPURL</span>,</span><br><span class="line">            <span class="attr">accounts</span>: [config.<span class="property">privateKey</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> hardhatUserConfig;</span><br></pre></td></tr></table></figure>

<h3 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a><code>package.json</code></h3><p>在<code>package.json</code>中添加以下命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat compile&quot;</span><span class="punctuation">,</span> <span class="comment">// 编译</span></span><br><span class="line">    <span class="attr">&quot;deploy-local&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run scripts/deploy.ts --network localhost&quot;</span><span class="punctuation">,</span> <span class="comment">// 部署到本地测试网</span></span><br><span class="line">    <span class="attr">&quot;deploy-sepolia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run scripts/deploy.ts --network sepolia&quot;</span><span class="punctuation">,</span> <span class="comment">// 部署到sepolia测试网</span></span><br><span class="line">    <span class="attr">&quot;testnet&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat node&quot;</span><span class="punctuation">,</span>  <span class="comment">// 启动本地测试网</span></span><br><span class="line">    <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat console --network localhost&quot;</span>    <span class="comment">// 启动hardhat命令行,</span></span><br><span class="line">    <span class="attr">&quot;exec-local&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run --network localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exec-sepolia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run --network sepolia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat test&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="合约部分"><a href="#合约部分" class="headerlink" title="合约部分"></a>合约部分</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.18;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ERC721NFT is ERC721, ERC721Enumerable, ERC721URIStorage, Ownable &#123;</span><br><span class="line">    using Counters for Counters.Counter;</span><br><span class="line"></span><br><span class="line">    Counters.Counter private _tokenIDCounter;</span><br><span class="line">    uint256 private _tokenNumLimit;</span><br><span class="line">    string private _description;</span><br><span class="line"></span><br><span class="line">    event SafeMintReturnValue(uint256);</span><br><span class="line"></span><br><span class="line">    constructor(uint256 tokenNumLimit, string memory description) ERC721(&quot;ERC721NFT&quot;, &quot;Joy&quot;) &#123;</span><br><span class="line">        _tokenNumLimit = tokenNumLimit;</span><br><span class="line">        _description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function safeMint(address target, string memory tokenMetadataURI) public &#123;</span><br><span class="line">        require(_tokenIDCounter.current() &lt;= _tokenNumLimit, &quot;NFT number reaches the limit&quot;);</span><br><span class="line">        uint256 tokenID = _tokenIDCounter.current();</span><br><span class="line">        _tokenIDCounter.increment();</span><br><span class="line">        _safeMint(target, tokenID);</span><br><span class="line">        _setTokenURI(tokenID, tokenMetadataURI);</span><br><span class="line">        emit SafeMintReturnValue(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setDescription(string memory description) public onlyOwner &#123;</span><br><span class="line">        _description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 以下为父类要求实现的接口</span><br><span class="line"></span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 firstTokenID, uint batchSize) internal override(ERC721, ERC721Enumerable) &#123;</span><br><span class="line">        super._beforeTokenTransfer(from, to, firstTokenID, batchSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(uint256 tokenID) internal override(ERC721, ERC721URIStorage) &#123;</span><br><span class="line">        super._burn(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function supportsInterface(bytes4 interfaceID) public view override(ERC721, ERC721Enumerable, ERC721URIStorage) returns (bool) &#123;</span><br><span class="line">        return super.supportsInterface(interfaceID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenURI(uint256 tokenID) public view override(ERC721, ERC721URIStorage) returns (string memory) &#123;</span><br><span class="line">        return super.tokenURI(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hardhat-部署脚本"><a href="#hardhat-部署脚本" class="headerlink" title="hardhat 部署脚本"></a>hardhat 部署脚本</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hardhat <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs/promises&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Config</span>&#125; <span class="keyword">from</span> <span class="string">&quot;./type&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> configPath = path.<span class="title function_">resolve</span>(<span class="string">&quot;./config.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultConfig = &#123;</span><br><span class="line">    <span class="string">&quot;APIKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;privateKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;publicKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;alchemyHTTPURL&quot;</span>: <span class="string">&quot;https://eth-sepolia.g.alchemy.com/v2/114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;contractName&quot;</span>: <span class="string">&quot;NFT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;contractAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;networkName&quot;</span>: <span class="string">&quot;sepolia&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A ERC721-NFT Demo of NeWive&quot;</span>,</span><br><span class="line">    <span class="string">&quot;limit&quot;</span>: <span class="number">10</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">readConfig</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Config</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>((<span class="keyword">await</span> fs.<span class="title function_">readFile</span>(configPath)).<span class="title function_">toString</span>()) <span class="keyword">as</span> <span class="title class_">Config</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`采用默认配置: <span class="subst">$&#123;defaultConfig&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateContractAddress</span>(<span class="params">config: Config, address: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        config.<span class="property">contractAddress</span> = address;</span><br><span class="line">        <span class="keyword">await</span> fs.<span class="title function_">writeFile</span>(configPath, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deploy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> config = <span class="keyword">await</span> <span class="title function_">readConfig</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ERC721NFTContractFactory</span> = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;ERC721NFT&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> contractInstance = <span class="keyword">await</span> <span class="title class_">ERC721NFTContractFactory</span>.<span class="title function_">deploy</span>(config.<span class="property">limit</span>, config.<span class="property">description</span>);</span><br><span class="line">    <span class="keyword">await</span> contractInstance.<span class="title function_">deployed</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract deployed at address: <span class="subst">$&#123;contractInstance.address&#125;</span>, owner: <span class="subst">$&#123;<span class="keyword">await</span> contractInstance.signer.getAddress()&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">await</span> <span class="title function_">updateContractAddress</span>(config, contractInstance.<span class="property">address</span>)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Contract address updated successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">deploy</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Deployed Succeeded&quot;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>完成后执行向本地测试网部署命令<code>npm run deploy-local</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_1.png" class="" title="Alchemy日志">

<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_2.png" class="" title="Etherscan-Sepolia日志">

<h2 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">import hardhat from &quot;hardhat&quot;;</span><br><span class="line">import chai from &quot;chai&quot;;</span><br><span class="line">import config from &quot;../config.json&quot;;</span><br><span class="line">import &#123;expect&#125; from &quot;chai&quot;;</span><br><span class="line"></span><br><span class="line">describe(&quot;ERC721MFT&quot;, function () &#123;</span><br><span class="line">    before(async function () &#123;</span><br><span class="line">        this.Contract = await hardhat.ethers.getContractFactory(&quot;ERC721NFT&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    beforeEach(async function () &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.contract = await this.Contract.deploy(config.limit, config.description);</span><br><span class="line">            await this.contract.deployed();</span><br><span class="line">            const signers = await hardhat.ethers.getSigners();</span><br><span class="line">            this.owner = signers.splice(0,1)[0];</span><br><span class="line">            this.collector = signers;</span><br><span class="line">            this.mintCount = 3;</span><br><span class="line">            this.tokenID = [];</span><br><span class="line">            let p = [];</span><br><span class="line">            for(let i = 0; i &lt; this.mintCount; ++i) &#123;</span><br><span class="line">                p.push(this.contract.safeMint(this.collector[i].address, i.toString()));</span><br><span class="line">                this.tokenID.push(i);</span><br><span class="line">            &#125;</span><br><span class="line">            await Promise.all(p);</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">            console.log(e);</span><br><span class="line">            process.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;Contract Name: ERC721&quot;, async function () &#123;</span><br><span class="line">        expect(await this.contract.name()).to.equal(&quot;ERC721NFT&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&#x27;合约的Symbol为Joy&#x27;, async function () &#123;</span><br><span class="line">        expect(await this.contract.symbol()).to.equal(&quot;Joy&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;合约拥有者能正确对应&quot;, async function() &#123;</span><br><span class="line">        for(let i = 0; i &lt; this.mintCount; ++i) &#123;</span><br><span class="line">            expect(await this.contract.ownerOf(this.tokenID[i])).to.equal(this.collector[i].address);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以遍历NFT个数&quot;, async function () &#123;</span><br><span class="line">        console.log(this.tokenID.length);</span><br><span class="line">        expect((await this.contract.balanceOf(this.collector[0].address)).toString()).to.equal(&quot;1&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以铸造新的NFT&quot;, async function () &#123;</span><br><span class="line">        const nTokenID = this.tokenID.length;</span><br><span class="line">        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);</span><br><span class="line">        expect(await this.contract.ownerOf(nTokenID)).to.equal(this.collector[nTokenID].address);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;触发SafeMintReturnValue事件&quot;, async function () &#123;</span><br><span class="line">        const nTokenID = this.tokenID.length;</span><br><span class="line">        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);</span><br><span class="line">        expect(await this.contract.ownerOf(nTokenID))</span><br><span class="line">            .to</span><br><span class="line">            .emit(this.contract, &quot;SafeMintReturnValue&quot;)</span><br><span class="line">            .withArgs(nTokenID);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;只能铸造一定次数的NFT&quot;, async function () &#123;</span><br><span class="line">        for(let i = 3; i &lt;= 10; ++i) &#123;</span><br><span class="line">            await this.contract.safeMint(this.collector[i].address, i);</span><br><span class="line">        &#125;</span><br><span class="line">        await expect(this.contract.safeMint(this.collector[11].address, &quot;11&quot;))</span><br><span class="line">            .to</span><br><span class="line">            .be</span><br><span class="line">            .revertedWith(&quot;NFT number reaches the limit&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&#x27;可以正确展示合约描述&#x27;, async function () &#123;</span><br><span class="line">        expect(await this.contract.getDescription())</span><br><span class="line">            .to</span><br><span class="line">            .equal(config.description);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以修改合约描述&quot;, async function () &#123;</span><br><span class="line">        await this.contract.setDescription(&quot;114514&quot;);</span><br><span class="line">        expect(await this.contract.getDescription())</span><br><span class="line">            .to</span><br><span class="line">            .equal(&quot;114514&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行<code>npm run test</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/test_1.png" class="" title="测试输出">

<h2 id="交互脚本"><a href="#交互脚本" class="headerlink" title="交互脚本"></a>交互脚本</h2><p>此处提供三种可选的交互方式，包括</p>
<ul>
<li>hardhat</li>
<li>web3js</li>
<li>alchemy-sdk</li>
</ul>
<h3 id="基于hardhat"><a href="#基于hardhat" class="headerlink" title="基于hardhat"></a>基于hardhat</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// integrateByHardhat.ts</span></span><br><span class="line"><span class="keyword">import</span> hardhat <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateByHardhat</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 链接合约</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Contract</span> = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;ERC721NFT&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> contract = <span class="keyword">await</span> <span class="title class_">Contract</span>.<span class="title function_">attach</span>(config.<span class="property">contractAddress</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 合约信息</span></span><br><span class="line">    <span class="keyword">const</span> name = <span class="keyword">await</span> contract.<span class="title function_">name</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">symbol</span> = <span class="keyword">await</span> contract.<span class="title function_">symbol</span>();</span><br><span class="line">    <span class="keyword">const</span> description = <span class="keyword">await</span> contract.<span class="title function_">getDescription</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract name: <span class="subst">$&#123;name&#125;</span>, Contract symbol: <span class="subst">$&#123;<span class="built_in">symbol</span>&#125;</span>, Description: <span class="subst">$&#123;description&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户信息</span></span><br><span class="line">    <span class="keyword">const</span> signers = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getSigners</span>();</span><br><span class="line">    <span class="keyword">const</span> owner = signers.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract Owner: <span class="subst">$&#123;owner.address&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> collectors = signers.<span class="title function_">map</span>(<span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">address</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract Collectors: <span class="subst">$&#123;collectors.join(<span class="string">&quot;,&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 铸币</span></span><br><span class="line">    contract.<span class="title function_">once</span>(<span class="string">&quot;SafeMintReturnValue&quot;</span>, <span class="function">(<span class="params">tokenID</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`铸币成功，tokenID为<span class="subst">$&#123;tokenID&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> tx = (<span class="keyword">await</span> contract.<span class="title function_">safeMint</span>(owner.<span class="property">address</span>, <span class="string">&quot;ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF&quot;</span>));</span><br><span class="line">    <span class="keyword">await</span> tx.<span class="title function_">wait</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// owner拥有的NFT数量</span></span><br><span class="line">    <span class="keyword">const</span> balanceOfOwner = <span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(owner.<span class="property">address</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The balance of the owner: <span class="subst">$&#123;balanceOfOwner&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改信息</span></span><br><span class="line">    <span class="keyword">const</span> tx1 = <span class="keyword">await</span> contract.<span class="title function_">setDescription</span>(<span class="string">`<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleDateString()&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">await</span> tx1.<span class="title function_">wait</span>();</span><br><span class="line">    <span class="keyword">const</span> nDescription = <span class="keyword">await</span> contract.<span class="title function_">getDescription</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(nDescription);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateByHardhat</span>();</span><br></pre></td></tr></table></figure>

<p>其中涉及修改链上状态的方法例如<code>safeMint</code>以及<code>setDescription</code>都需要使用wait等待交易被确认。<br>执行<code>npm run exec-sepolia ./scripts/integrateByHardhat.ts</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/hardhat_1.png" class="" title="hardhat输出">

<h3 id="基于web3js"><a href="#基于web3js" class="headerlink" title="基于web3js"></a>基于web3js</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Web3</span> <span class="keyword">from</span> <span class="string">&quot;web3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> contractArtifacts <span class="keyword">from</span> <span class="string">&quot;../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">AbiItem</span>&#125; <span class="keyword">from</span> <span class="string">&quot;web3-utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TransactionConfig</span>, <span class="title class_">EventLog</span>&#125; <span class="keyword">from</span> <span class="string">&quot;web3-core&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateByWeb3</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 将alchemyHTTP作为Provider传递给Web3</span></span><br><span class="line">    <span class="keyword">const</span> alchemy = <span class="keyword">new</span> <span class="title class_">Web3</span>(config.<span class="property">alchemyHTTPURL</span>);</span><br><span class="line">    <span class="comment">// 添加一个钱包账号</span></span><br><span class="line">    <span class="keyword">const</span> account = alchemy.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="property">wallet</span>.<span class="title function_">add</span>(config.<span class="property">privateKey</span>);</span><br><span class="line">    <span class="comment">// 创建一个合约实例</span></span><br><span class="line">    <span class="keyword">const</span> contract = <span class="keyword">new</span> alchemy.<span class="property">eth</span>.<span class="title class_">Contract</span>(contractArtifacts.<span class="property">abi</span> <span class="keyword">as</span> <span class="title class_">Array</span>&lt;<span class="title class_">AbiItem</span>&gt;, config.<span class="property">contractAddress</span>);</span><br><span class="line">    <span class="comment">// 事件监听</span></span><br><span class="line">    <span class="keyword">const</span> safeMintEventListener = <span class="keyword">await</span> contract</span><br><span class="line">        .<span class="property">events</span></span><br><span class="line">        .<span class="title class_">SafeMintReturnValue</span>(&#123;</span><br><span class="line">            <span class="attr">filter</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">fromBlock</span>: <span class="string">&quot;latest&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建交易， works</span></span><br><span class="line">    <span class="comment">// safeMintEventListener.on(&quot;data&quot;, (e:EventLog) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(e.returnValues);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// safeMintEventListener.on(&quot;connected&quot;, function(subscriptionId: EventLog)&#123;</span></span><br><span class="line">    <span class="comment">//     console.log(subscriptionId);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="keyword">const</span> gasPrice = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getGasPrice</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">tx</span>: <span class="title class_">TransactionConfig</span> = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        gasPrice,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getTransactionCount</span>(config.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="attr">data</span>: contract.<span class="property">methods</span>.<span class="title function_">safeMint</span>(config.<span class="property">publicKey</span>, <span class="string">&quot;ipfs://1145141910811&quot;</span>).<span class="title function_">encodeABI</span>(),</span><br><span class="line">        <span class="attr">gas</span>: <span class="number">210000</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 发送交易，如果该交易是通过一个存在的账号发送则会自动签署</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(tx);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过签署交易然后发送</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> contract.<span class="property">methods</span>.<span class="title function_">getDescription</span>().<span class="title function_">call</span>());</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">tx1</span>: <span class="title class_">TransactionConfig</span> = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        gasPrice,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getTransactionCount</span>(config.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="attr">data</span>: contract.<span class="property">methods</span>.<span class="title function_">setDescription</span>(<span class="string">&quot;你是一个一个一个&quot;</span>).<span class="title function_">encodeABI</span>(),</span><br><span class="line">        <span class="attr">gas</span>: <span class="number">210000</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> signedTX = <span class="keyword">await</span> account.<span class="title function_">signTransaction</span>(tx1);</span><br><span class="line">    <span class="keyword">const</span> res1 = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">sendSignedTransaction</span>(signedTX.<span class="property">rawTransaction</span> <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res1);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> contract.<span class="property">methods</span>.<span class="title function_">getDescription</span>().<span class="title function_">call</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Not Work, 只获取到返回值而sepolia etherscan中没有mint记录，call不会改变链上的状态</span></span><br><span class="line">    <span class="comment">// const tx = await contract.methods.safeMint(config.publicKey, &quot;ipfs://1145141910811&quot;).call();</span></span><br><span class="line">    <span class="comment">// console.log(tx);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateByWeb3</span>();</span><br></pre></td></tr></table></figure>

<p>其中未解决发送交易调用函数的返回值与事件监听的问题。</p>
<h3 id="基于alchemy-sdk"><a href="#基于alchemy-sdk" class="headerlink" title="基于alchemy-sdk"></a>基于alchemy-sdk</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Network</span>, <span class="title class_">Utils</span>, <span class="title class_">Wallet</span>, <span class="title class_">Alchemy</span>&#125; <span class="keyword">from</span> <span class="string">&quot;alchemy-sdk&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> contractArtifacts <span class="keyword">from</span> <span class="string">&quot;../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TransactionRequest</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@ethersproject/providers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">&quot;ethers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> settings = &#123;</span><br><span class="line">    <span class="attr">apiKey</span>: config.<span class="property">APIKey</span>,</span><br><span class="line">    <span class="attr">network</span>: <span class="title class_">Network</span>.<span class="property">ETH_SEPOLIA</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">FunctionName</span> &#123;</span><br><span class="line">    [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> web3 = <span class="keyword">new</span> <span class="title class_">Alchemy</span>(settings);</span><br><span class="line"><span class="keyword">const</span> wallet = <span class="keyword">new</span> <span class="title class_">Wallet</span>(config.<span class="property">privateKey</span>, web3);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateAlchemySDK</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取给出地址的所有的NFT</span></span><br><span class="line">    <span class="keyword">const</span> allNFTs = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getNftsForOwner</span>(config.<span class="property">publicKey</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(allNFTs);</span><br><span class="line">    <span class="comment">// // 根据tokenID获取Owner</span></span><br><span class="line">    <span class="keyword">const</span> owner = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getOwnersForNft</span>(config.<span class="property">contractAddress</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(owner);</span><br><span class="line">    <span class="comment">// // 根据合约获取所有owner</span></span><br><span class="line">    <span class="keyword">const</span> owners = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getOwnersForContract</span>(config.<span class="property">contractAddress</span>, &#123;</span><br><span class="line">        <span class="attr">withTokenBalances</span>: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(owners);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用会改变链上状态的方法</span></span><br><span class="line">    <span class="comment">// 解析ABI</span></span><br><span class="line">    <span class="keyword">const</span> contractInterface = <span class="keyword">new</span> <span class="title class_">Utils</span>.<span class="title class_">Interface</span>(contractArtifacts.<span class="property">abi</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">functionName</span>: <span class="title class_">FunctionName</span> = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> contractInterface.<span class="property">functions</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(contractInterface.<span class="property">functions</span>, k)) &#123;</span><br><span class="line">            functionName[contractInterface.<span class="property">functions</span>[k].<span class="property">name</span> <span class="keyword">as</span> <span class="built_in">string</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对方法进行ABI编码</span></span><br><span class="line">    <span class="keyword">const</span> safeMintEncoded = contractInterface.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;safeMint&quot;</span>, [config.<span class="property">publicKey</span>, <span class="string">&quot;ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF&quot;</span>])</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(safeMintEncoded);</span><br><span class="line">    <span class="comment">// 获取nonce</span></span><br><span class="line">    <span class="keyword">const</span> nonce = <span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getTransactionCount</span>(</span><br><span class="line">        wallet.<span class="property">address</span>,</span><br><span class="line">        <span class="string">&quot;latest&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 获取gasPrice，是必要的一步，不获取会抛出Transaction Underpriced错误</span></span><br><span class="line">    <span class="keyword">const</span> gasPrice = (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getFeeData</span>()).<span class="property">gasPrice</span>;</span><br><span class="line">    <span class="keyword">const</span> transaction = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">gasLimit</span>: <span class="number">21000000</span>,</span><br><span class="line">        <span class="attr">data</span>: safeMintEncoded,</span><br><span class="line">        nonce,</span><br><span class="line">        gasPrice</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> signedTransact = <span class="keyword">await</span> wallet.<span class="title function_">signTransaction</span>(transaction <span class="keyword">as</span> <span class="title class_">TransactionRequest</span>);</span><br><span class="line">    <span class="keyword">const</span> sentTX = <span class="keyword">await</span> (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">sendTransaction</span>(signedTransact)).<span class="title function_">wait</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sentTX);</span><br><span class="line">    <span class="comment">// 获取事件日志</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SafeMintReturnValue</span> = contractInterface.<span class="title function_">encodeFilterTopics</span>(<span class="string">&quot;SafeMintReturnValue&quot;</span>, []);</span><br><span class="line">    <span class="keyword">const</span> logs = <span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getLogs</span>(&#123;</span><br><span class="line">        <span class="attr">toBlock</span>: <span class="string">&quot;latest&quot;</span>,</span><br><span class="line">        <span class="attr">address</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">topics</span>: <span class="title class_">SafeMintReturnValue</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;日志: &quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(logs[<span class="number">0</span>].<span class="property">data</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// call不能调用改变链上状态的方法</span></span><br><span class="line">    <span class="keyword">const</span> messageABIEncoded = contractInterface.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;getDescription&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> resHex = (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">call</span>(&#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">data</span>: messageABIEncoded,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> wallet.<span class="title function_">getTransactionCount</span>()</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(resHex);</span><br><span class="line">    <span class="comment">// 解析字符串</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ethers.<span class="property">utils</span>.<span class="title function_">toUtf8String</span>(resHex));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateAlchemySDK</span>();</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/" data-id="cli5d2ofj00000ohk696862c4" data-title="ERC721简易项目开发Demo" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ERC721/" rel="tag">ERC721</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/alchemy/" rel="tag">alchemy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web3js/" rel="tag">web3js</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          Hardhat笔记
        
      </div>
    </a>
  
  
    <a href="/2023/05/19/ERC721/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">ERC721</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ERC721/" rel="tag">ERC721</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFT/" rel="tag">NFT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alchemy/" rel="tag">alchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openzeppelin/" rel="tag">openzeppelin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3js/" rel="tag">web3js</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ERC721/" style="font-size: 10px;">ERC721</a> <a href="/tags/NFT/" style="font-size: 13.33px;">NFT</a> <a href="/tags/Smart-Contract/" style="font-size: 20px;">Smart Contract</a> <a href="/tags/Solidity/" style="font-size: 16.67px;">Solidity</a> <a href="/tags/alchemy/" style="font-size: 10px;">alchemy</a> <a href="/tags/hardhat/" style="font-size: 13.33px;">hardhat</a> <a href="/tags/openzeppelin/" style="font-size: 10px;">openzeppelin</a> <a href="/tags/solidity/" style="font-size: 13.33px;">solidity</a> <a href="/tags/web3js/" style="font-size: 10px;">web3js</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/">Openzeppelin笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/">Hardhat笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/">ERC721简易项目开发Demo</a>
          </li>
        
          <li>
            <a href="/2023/05/19/ERC721/">ERC721</a>
          </li>
        
          <li>
            <a href="/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">Solidity智能合约基本概念</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 NeWive<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>