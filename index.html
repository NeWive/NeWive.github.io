<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>NeWive&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="经常画大饼，偶尔产出鸽子蛋">
<meta property="og:type" content="website">
<meta property="og:title" content="NeWive&#39;s Blog">
<meta property="og:url" content="https://newive.github.io/index.html">
<meta property="og:site_name" content="NeWive&#39;s Blog">
<meta property="og:description" content="经常画大饼，偶尔产出鸽子蛋">
<meta property="og:locale">
<meta property="article:author" content="NeWive">
<meta property="article:tag" content="FrontEnd">
<meta property="article:tag" content="Solidity">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="NeWive's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">NeWive&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">NeWive的鸽子窝</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://newive.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Openzeppelin笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2023-05-27T01:39:38.000Z" itemprop="datePublished">2023-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/">Openzeppelin笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="通过继承的方式使用"><a href="#通过继承的方式使用" class="headerlink" title="通过继承的方式使用"></a>通过继承的方式使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ModifierAccessControl is AccessControl &#123;</span><br><span class="line">	function revokeRole(bytes32 role, address account) public override &#123;</span><br><span class="line">		require(role != DEFEAULT_ADMIN_ROLE, &quot;ModifierdAccessControl: Cannot revoke def&quot;);</span><br><span class="line">		super.revokeRule(role, account);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用hooks"><a href="#使用hooks" class="headerlink" title="使用hooks"></a>使用hooks</h2><p>使用 <code>_beforeTokenTranser</code> hook拓展ERC20中的 <code>IERC721Receiver</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ERC20WithSafeTranser is ERC20 &#123;</span><br><span class="line">	function _beforeTOkenTransfer(address from, address to, uint256 amount) internal virtual override &#123;</span><br><span class="line">	super._beforeTokenTranser(from, to, amount);</span><br><span class="line">	require(_validRecipient(to), &quot;ERC20WithSafeTransfer: invalid recipient&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Hook的规则：</p>
<ol>
<li>当重写hook时对新的函数添加 <code>virtual</code> 属性以便于后续子合约对其拓展。</li>
<li>总是通过 <code>super</code> 的方式调用父hook以确保在继承树中的所有hook都被调用。</li>
</ol>
<h2 id="upgradeability"><a href="#upgradeability" class="headerlink" title="upgradeability"></a>upgradeability</h2><p>可升级的合约：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @openzeppelin/contracts-upgradeable</span><br></pre></td></tr></table></figure>

<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><h3 id="合约的所有权"><a href="#合约的所有权" class="headerlink" title="合约的所有权"></a>合约的所有权</h3><p><code>Ownable.sol</code> 提供对判定合约函数所有者相关的API。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contracts/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyContract is Ownable &#123;</span><br><span class="line">	function normalThing() public &#123;</span><br><span class="line">		//...</span><br><span class="line">	&#125;</span><br><span class="line">	function specialThing() public onlyOwner &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Ownable</code>合约默认部署合约者作为合约的所有者。同时该合约还可以</p>
<ul>
<li><code>transferOwnership</code>: 修改合约所有人</li>
<li><code>renounceOwnership</code>: 当前所有人放弃所有权</li>
</ul>
<p>注意移除所有者之后<code>onlyOwner</code>装饰器将不可用。</p>
<h3 id="基于角色的访问控制"><a href="#基于角色的访问控制" class="headerlink" title="基于角色的访问控制"></a>基于角色的访问控制</h3><p><code>AccessControl.sol</code> 提供基于角色的访问控制相关的API。</p>
<p>通过创建一个新的角色标识符 <code>role identifier</code> 来进行访问控制。一般 <code>role identifier</code> 是一段通过keccak256生成的哈希。</p>
<p>通过 <code>_grantRole</code> 创建角色。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	constructor(address minter) ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(MINTER_ROLE, minter);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public &#123;</span><br><span class="line">		require(hasRole(MINTER_ROLE, msg.sender), &quot;Caller is not a minter&quot;);</span><br><span class="line">		_mint(to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>onlyRole</code> 装饰器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	bytes32 public constant BURNER_ROLE = keccak256(&quot;BURNER&quot;);</span><br><span class="line">	constructor(address minter, address burner) ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(MINTER_ROLE, minter);</span><br><span class="line">		_grantRole(BURNER_ROLE, burner);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public onlyRole(MINTER_ROLE) &#123;</span><br><span class="line">		_mint(to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function burn(address from, uint256 amount) public onlyRole(BURNER_ROLE) &#123;</span><br><span class="line">		_burn(from, amount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="管理角色权限"><a href="#管理角色权限" class="headerlink" title="管理角色权限"></a>管理角色权限</h3><p>默认情况下，具有角色的帐户不能授予它或从其他帐户中撤销它。为了动态的管理角色权限需要一个角色管理员(role admin)。</p>
<p>每个角色都有一个相关联的管理员角色用来授权调用 <code>_grantRole</code>与 <code>_revokeRole</code>。<code>AccessControl.sol</code> 具有一个特殊的role <code>DEFAULT_ADMIN_ROLE</code>以作为所有角色的默认管理员角色，可以通过调用 <code>_setRoleAdmin</code> 修改管理员角色。</p>
<p>但是 <code>DEFAULT_ADMIN_ROLE</code> 因为也是自己的管理员所以具有风险。可以使用 <code>AccessControlDefaultAdminRules</code> 来对管理员角色添加强制安全措施。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contracts/access/AccessControl.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, AccessControl &#123;</span><br><span class="line">	bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER&quot;);</span><br><span class="line">	bytes32 public constant BURNER_ROLE = keccak256(&quot;BURNER&quot;);</span><br><span class="line">	constructor() ERC20(&quot;MyToken&quot;, &quot;TKN&quot;) &#123;</span><br><span class="line">		_grantRole(DEFAULT_ADMIN_ROLE, msg.sender);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function mint(address to, uint256 amount) public onlyRole(MINTER_ROLE) &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function burn(address from, uint256 amount) public onlyRole(BURNER_ROLE) &#123;</span><br><span class="line">        _burn(from, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于DEFAULT_ADMIN_RULE被设置成为 <code>msg.sender</code>，该账户可以调用 <code>grantRole</code> 来授予别的账户以角色。</p>
<h3 id="遍历特权角色"><a href="#遍历特权角色" class="headerlink" title="遍历特权角色"></a>遍历特权角色</h3><p><code>AccessControl.sol</code> 使用 <code>EnumerableSet</code> 来保存角色信息，可以通过 <code>getRoleMemberCount</code> 来获取特权角色账户的数量。通过 <code>getRoleMember</code>来获取每一位角色。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> minterCount = <span class="keyword">await</span> myToken.<span class="title function_">getRoleMemberCount</span>(<span class="variable constant_">MINTER_ROLE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> members = [];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; minterCount; ++i) &#123;</span><br><span class="line">    members.<span class="title function_">push</span>(<span class="keyword">await</span> myToken.<span class="title function_">getRoleMember</span>(<span class="variable constant_">MINTER_ROLE</span>, i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="延迟操作-Delayed-Operation"><a href="#延迟操作-Delayed-Operation" class="headerlink" title="延迟操作(Delayed Operation)"></a>延迟操作(Delayed Operation)</h2><p>访问控制无法防止内部管理员搞事，因此可以使用 <code>TimelockController</code>。</p>
<p><code>TimelockController</code> 是一个由提议者<code>proposers</code>和执行者<code>executors</code>管理的代理。当设置好管理员后它确保提议者下令进行的任何维护操作都可能会延迟。这个延迟为合约的用户提供时间确保维护操作的合理性。</p>
<p>默认情况下部署合约的地址为 <code>TimelockController</code> 在时间锁上的管理员。这个角色授予任命proposer、executor和其他管理员的权利。</p>
<p><code>TimelockController</code> 需要至少任命一个proposer和一个executor。这些角色可以是相同的账户。同时角色 <code>ADMIN_ROLE</code>、  <code>PROPOSER_ROLE</code>、<code>EXECUTOR_ROLE</code> 基于<code>AccessControl</code> 实现。</p>
<h2 id="合约的标准"><a href="#合约的标准" class="headerlink" title="合约的标准"></a>合约的标准</h2><ul>
<li>ERC20: 同质化资源的token标准</li>
<li>ERC721: 非同质化token(NFT)的标准</li>
<li>ERC777: 更丰富的同质化token标准</li>
</ul>
<h2 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h2><p>符合ERC20的token主要用于交换货币、投票选举等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzepplin/contract/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GLDToken is ERC20 &#123;</span><br><span class="line">	constructor(uint256 initialSupply) ERC20(&quot;Gold&quot;, &quot;GLD&quot;) &#123;</span><br><span class="line">		_mint(msg.sender, initialSupply);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ERC721"><a href="#ERC721" class="headerlink" title="ERC721"></a>ERC721</h2><p>ERC721是代表NFT所有权的一个标准。</p>
<h3 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h3><p>使用ERC721处理游戏中的物品。当一个物品要奖励给一个玩家时，它会被进行挖矿获取token并发送给玩家。玩家可以自由的保管这些token或者是与他人进行交易。需要注意的是任何人都可以调用 <code>awardItem</code> 来挖掘物品，为了约束这一行为需要增加访问控制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">import &quot;@openzepplin/contract/token/ERC721/extensions/ERC721URIStorage.sol&quot;;</span><br><span class="line">import &quot;@openzepplin/contracts/utils/Counters.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract GameItem is ERC721URIStorage &#123;</span><br><span class="line">	using Counters for Counters.Counter;</span><br><span class="line">	Counters.Counter private _tokenIds;</span><br><span class="line">	</span><br><span class="line">	constructor() ERC721(&quot;GameItem&quot;, &quot;ITM&quot;) &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function awardItem(address player, string memory tokenURI) &#123;</span><br><span class="line">		uint256 newItemId = _tokenIds.current();</span><br><span class="line">		_mint(player, newItemId);</span><br><span class="line">		_setTokenURI(newItemId, tokenURI);</span><br><span class="line">		_tokenIds.increment();</span><br><span class="line">		return newItemId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC721URIStorage</code>合约是ERC721的一个实现，包含元数据标准扩展 <code>IERC721Metadata</code> 和一个关于每个令牌元数据的机制。使用 <code>_setTokenURI</code>保存一个物品的元数据。</p>
<p>需要注意的是ERC721的token不可再分割，且是独一无二的。</p>
<h2 id="链上治理-On-Chain-Governance"><a href="#链上治理-On-Chain-Governance" class="headerlink" title="链上治理(On-Chain Governance)"></a>链上治理(On-Chain Governance)</h2><p>治理协议通常以一个特殊目的的合约实现，称为 <code>Governor</code>。</p>
<h3 id="样例-1"><a href="#样例-1" class="headerlink" title="样例"></a>样例</h3><h4 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h4><p>在治理协议的构建中每个账户的选举权利会由一个ERC20 Token决定。这个token必须实现<code>ERC20Votes</code>拓展。这个拓展会持续追踪历史余额以便投票权是从过去的快照而不是当前余额中检索的，这是一个对防止多次选举的重要保护。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, ERC20Permit, ERC20Votes &#123;</span><br><span class="line">	constructor() ERC20(&quot;MyToken&quot;, &quot;MTK&quot;) ERC20Permit(&quot;MyToken&quot;) &#123;&#125;</span><br><span class="line">	</span><br><span class="line">	function _afterTokenTransfer(address from, address to, uint256 amount) internal override(ERC20m ERC20Votes) &#123;</span><br><span class="line">		super._afterTokenTransfer(from, to, amount);</span><br><span class="line">	&#125;</span><br><span class="line">	    function _mint(address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._burn(account, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您的项目已经有一个不包含 <code>ERC20Votes</code> 且不可升级的实时令牌，您可以使用 <code>ERC20Wrapper</code> 将其包装在治理token中。这将允许token持有者通过一对一包装他们的token来参与治理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Wrapper.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyToken is ERC20, ERC20Permit, ERC20Votes, ERC20Wrapper &#123;</span><br><span class="line">    constructor(IERC20 wrappedToken)</span><br><span class="line">        ERC20(&quot;MyToken&quot;, &quot;MTK&quot;)</span><br><span class="line">        ERC20Permit(&quot;MyToken&quot;)</span><br><span class="line">        ERC20Wrapper(wrappedToken)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // The functions below are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _afterTokenTransfer(address from, address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._afterTokenTransfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address to, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address account, uint256 amount)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Votes)</span><br><span class="line">    &#123;</span><br><span class="line">        super._burn(account, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：目前 OpenZeppelin 合约中唯一可用的其他投票权来源是 ERC721Votes。</p>
<p>不提供此功能的 ERC721 代币可以使用 ERC721Votes 和 ERC721Wrapper 的组合包装成投票代币。</p>
</blockquote>
<h4 id="Governor"><a href="#Governor" class="headerlink" title="Governor"></a>Governor</h4><p>考虑以下问题</p>
<ul>
<li><p>如何决定选举权力</p>
<blockquote>
<p>使用 GovernorVotes模块，该模块连接到 IVotes 实例，以根据提案激活时账户持有的代币余额来确定账户的投票权。</p>
<p>这个模块要求一个地址的token作为构造函数的参数。</p>
</blockquote>
</li>
<li><p>需要多少选举者才合法</p>
<blockquote>
<p>使用 GovernorVotesQuorumFraction模块，与ERC20Votes一起将人数定义为一个检索提案投票权的区块总供应量的百分比。</p>
</blockquote>
</li>
<li><p>人在投票时有什么选项，这些票是如何被计数的</p>
<blockquote>
<p>使用 GovernorCountingSimple模块提供选项，包括 <code>For</code>, <code>Against</code>, <code>Abstain</code>。只有 <code>For</code>, <code>Abstain</code> 被计入人数。</p>
</blockquote>
</li>
<li><p>用什么类型的token作为票</p>
</li>
</ul>
<p>同时Governor还需要确定几个参数</p>
<blockquote>
<p>These parameters are specified in the unit defined in the token’s clock. Assuming the token uses block numbers, and assuming block time of around 12 seconds, we will have set votingDelay &#x3D; 1 day &#x3D; 7200 blocks, and votingPeriod &#x3D; 1 week &#x3D; 50400 blocks.</p>
</blockquote>
<ul>
<li><p>votingDelay: 在创建提议后多长时间投票权确定</p>
<blockquote>
<p>ex: votingDelay &#x3D; 1 day &#x3D; 7200 blocks</p>
</blockquote>
</li>
<li><p>votingPeriod: 提议的投票持续多长时间</p>
<blockquote>
<p>ex: votingPeriod &#x3D; 1 week &#x3D; 50400 blocks.</p>
</blockquote>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.2;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/governance/Governor.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/compatibility/GovernorCompatibilityBravo.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorVotes.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorVotesQuorumFraction.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/governance/extensions/GovernorTimelockControl.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract MyGovernor is Governor, GovernorCompatibilityBravo, GovernorVotes, GovernorVotesQuorumFraction, GovernorTimelockControl &#123;</span><br><span class="line">    constructor(IVotes _token, TimelockController _timelock)</span><br><span class="line">        Governor(&quot;MyGovernor&quot;)</span><br><span class="line">        GovernorVotes(_token)</span><br><span class="line">        GovernorVotesQuorumFraction(4)</span><br><span class="line">        GovernorTimelockControl(_timelock)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function votingDelay() public pure override returns (uint256) &#123;</span><br><span class="line">        return 7200; // 1 day</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function votingPeriod() public pure override returns (uint256) &#123;</span><br><span class="line">        return 50400; // 1 week</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposalThreshold() public pure override returns (uint256) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The functions below are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function state(uint256 proposalId)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        override(Governor, IGovernor, GovernorTimelockControl)</span><br><span class="line">        returns (ProposalState)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.state(proposalId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function propose(address[] memory targets, uint256[] memory values, bytes[] memory calldatas, string memory description)</span><br><span class="line">        public</span><br><span class="line">        override(Governor, GovernorCompatibilityBravo, IGovernor)</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.propose(targets, values, calldatas, description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _execute(uint256 proposalId, address[] memory targets, uint256[] memory values, bytes[] memory calldatas, bytes32 descriptionHash)</span><br><span class="line">        internal</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">    &#123;</span><br><span class="line">        super._execute(proposalId, targets, values, calldatas, descriptionHash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _cancel(address[] memory targets, uint256[] memory values, bytes[] memory calldatas, bytes32 descriptionHash)</span><br><span class="line">        internal</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">        returns (uint256)</span><br><span class="line">    &#123;</span><br><span class="line">        return super._cancel(targets, values, calldatas, descriptionHash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _executor()</span><br><span class="line">        internal</span><br><span class="line">        view</span><br><span class="line">        override(Governor, GovernorTimelockControl)</span><br><span class="line">        returns (address)</span><br><span class="line">    &#123;</span><br><span class="line">        return super._executor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function supportsInterface(bytes4 interfaceId)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        override(Governor, IERC165, GovernorTimelockControl)</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        return super.supportsInterface(interfaceId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Timelock"><a href="#Timelock" class="headerlink" title="Timelock"></a>Timelock</h4><blockquote>
<p>注意，当使用Timelock时，是Timelock执行决议，因此Timelock合约拥有资金、所有权和对角色访问控制权。</p>
</blockquote>
<p>Timelock需要使用AccessControl设置角色。</p>
<ul>
<li><code>Proposer</code>：控制排队操作，且必须唯一</li>
<li><code>Executor</code>：控制执行已经存在且可行的操作，可以将之设置为0地址以便任何人执行操作。</li>
<li><code>Admin</code>：授予和撤销上述两个角色，默认会将Timelock自身设置为Admin</li>
</ul>
<h2 id="ERC-721-API"><a href="#ERC-721-API" class="headerlink" title="ERC 721 API"></a>ERC 721 API</h2><p>EIC制定了四个接口：</p>
<ul>
<li><p>IERC721: 在所有相关接口中包含的核心功能</p>
</li>
<li><p>IERC721Metadata: 增加名称、标志和token URI的科学拓展，常用</p>
</li>
<li><p>IERC721Enumerable: 允许遍历链上的token，因为消耗大量gas不常用</p>
</li>
<li><p>IERC721Receiver: 如果想要通过 <code>safeTransferFrom</code> 接收token则必须实现的接口</p>
</li>
<li><p>ERC721Consecutive</p>
</li>
<li><p>ERC721URIStorage: 一种更灵活但是开销更大的存储元数据的方法</p>
</li>
<li><p>ERC721Votes</p>
</li>
<li><p>ERC721Royalty</p>
</li>
<li><p>ERC721Pausable</p>
</li>
<li><p>ERC721Burnable</p>
</li>
<li><p>ERC721Wrapper: 用于创建由另一个 ERC721 支持的 ERC721 的包装器，具有存款和取款方法。与 ERC721Votes 结合使用很有用。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/" data-id="cli5d2ofy000x0ohk7h49fgoi" data-title="Openzeppelin笔记" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openzeppelin/" rel="tag">openzeppelin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Hardhat笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2023-05-27T01:38:31.000Z" itemprop="datePublished">2023-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/">Hardhat笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Hardhat 是一个以太坊应用的开发脚手架。当使用Hardhat时HardhatRunner是交互的主要组件，可以协助管理和自动化开发智能合约时的重复性任务。</p>
<p>Hardhat围绕tasks和plugins构建。每次从命令行执行hardhat都是在执行一个task，例如 <code>npx hardhat compile</code> 为执行一个compile task。task之间可以相互调用。</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="部署脚本"><a href="#部署脚本" class="headerlink" title="部署脚本"></a>部署脚本</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// deploy.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Box</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;Box&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> box = <span class="keyword">await</span> <span class="title class_">Box</span>.<span class="title function_">deploy</span>();</span><br><span class="line">    <span class="keyword">await</span> box.<span class="title function_">deployed</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="命令行交互"><a href="#命令行交互" class="headerlink" title="命令行交互"></a>命令行交互</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">npx hardhat console --network localhost</span><br><span class="line">Welcome to Node.js v12.22.1.</span><br><span class="line">Type &quot;.help&quot; for more information.</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">const Box = await ethers.getContractFactory(<span class="string">&#x27;Box&#x27;</span>);</span></span><br><span class="line">undefined</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">const box = await Box.attach(<span class="string">&#x27;0x5FbDB2315678afecb367f032d93F642f64180aa3&#x27;</span>)</span></span><br><span class="line">undefined</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">await box.store(42)</span></span><br><span class="line">&#123;</span><br><span class="line">  hash: &#x27;0x3d86c5c2c8a9f31bedb5859efa22d2d39a5ea049255628727207bc2856cce0d3&#x27;,</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="通过代码交互"><a href="#通过代码交互" class="headerlink" title="通过代码交互"></a>通过代码交互</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> accounts = <span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">listAccounts</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(accounts);</span><br><span class="line">    <span class="keyword">const</span> contractAddr = <span class="string">&quot;0x5fbdb2315678afecb367f032d93f642f64180aa3&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Box</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;Box&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> box = <span class="keyword">await</span> <span class="title class_">Box</span>.<span class="title function_">attach</span>(contractAddr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>((<span class="keyword">await</span> box.<span class="title function_">retrieve</span>()).<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">await</span> box.<span class="title function_">store</span>(<span class="number">114512</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>((<span class="keyword">await</span> box.<span class="title function_">retrieve</span>()).<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line"> 	<span class="attr">defaultNetwork</span>: <span class="string">&quot;sepolia&quot;</span>,</span><br><span class="line">    <span class="attr">networks</span>: &#123;</span><br><span class="line">        <span class="attr">hardhat</span>: &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">sepolia</span>: &#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&quot;https://sepolia.infura.in/v3/&lt;key&gt;&quot;</span>,</span><br><span class="line">            <span class="attr">accounts</span>: [privateKey1, privateKey2, ...]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">solidity</span>: &#123;</span><br><span class="line">        <span class="attr">version</span>: <span class="string">&quot;solidity-version&quot;</span>,</span><br><span class="line">        <span class="attr">settings</span>: &#123;</span><br><span class="line">            <span class="attr">optimizer</span>: &#123;</span><br><span class="line">                <span class="attr">enabled</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">runs</span>: <span class="number">200</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">path</span>: &#123;</span><br><span class="line">        <span class="attr">sources</span>: <span class="string">&quot;./contracts&quot;</span>,</span><br><span class="line">   	 	<span class="attr">tests</span>: <span class="string">&quot;./test&quot;</span>,</span><br><span class="line">    	<span class="attr">cache</span>: <span class="string">&quot;./cache&quot;</span>,</span><br><span class="line">    	<span class="attr">artifacts</span>: <span class="string">&quot;./artifacts&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mocha</span>: &#123;</span><br><span class="line">        <span class="attr">timeout</span>: <span class="number">40000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Networks-configuation"><a href="#Networks-configuation" class="headerlink" title="Networks configuation"></a>Networks configuation</h3><p><code>networks</code>用于将网络名称映射到对应的配置。Hardhat中有两种网络：基于JSON_RPC的网络与内置的Hardhat网络。通过配置 <code>defaultNetwork</code> 修改默认网络，默认为 <code>hardhat</code></p>
<h3 id="hardhat-config-ts"><a href="#hardhat-config-ts" class="headerlink" title="hardhat.config.ts"></a><code>hardhat.config.ts</code></h3><p>hardhat的大多数功能来源于插件，所以需要在 <code>hardhat.config.ts</code> 中引入插件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfundation/hardhat-toolbox&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">solidity</span>: <span class="string">&quot;0.8.9&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="测试单元"><a href="#测试单元" class="headerlink" title="测试单元"></a>测试单元</h2><h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><p>使用 <code>chai</code> 进行模拟区块链以及测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev chai</span><br></pre></td></tr></table></figure>

<p>使用test-helpers进行更详尽的测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">npm install --save-dev @openzeppelin/test-helpers</span></span><br></pre></td></tr></table></figure>

<h4 id="编写测试模块"><a href="#编写测试模块" class="headerlink" title="编写测试模块"></a>编写测试模块</h4><p>编写测试模块比较好的实践是在<code>test/</code>下对 <code>contract/</code>中的每个合约建立一个测试文件。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/Box.test.js</span></span><br><span class="line"><span class="comment">// Load dependencies</span></span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">&#x27;chai&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start test block</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Box&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">before</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">Box</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&#x27;Box&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">beforeEach</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">box</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">Box</span>.<span class="title function_">deploy</span>();</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">box</span>.<span class="title function_">deployed</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test case</span></span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&#x27;retrieve returns a value previously stored&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// Store a value</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">box</span>.<span class="title function_">store</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Test if the returned value is the same one</span></span><br><span class="line">        <span class="comment">// Note that we need to use strings to compare the 256 bit integers</span></span><br><span class="line">        <span class="title function_">expect</span>((<span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">box</span>.<span class="title function_">retrieve</span>()).<span class="title function_">toString</span>()).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&#x27;42&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行 <code>npx hardhat test</code> 会运行 <code>test/</code> 目录下的所有测试模块.</p>
<h3 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h3><h4 id="基础测试"><a href="#基础测试" class="headerlink" title="基础测试"></a>基础测试</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;expect&#125; <span class="keyword">from</span> <span class="string">&quot;chai&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> hre <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;time&#125; <span class="keyword">from</span> <span class="string">&quot;@nomicfoundation/hardhat-network-helpers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Lock&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&quot;unlock time should be in the future&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> lockedAmount = <span class="number">1_000_000_000</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="variable constant_">ONE_YEAR_IN_SECS</span> = <span class="number">356</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">const</span> unlockTime = (<span class="keyword">await</span> time.<span class="title function_">latest</span>()) + <span class="variable constant_">ONE_YEAR_IN_SECS</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">Lock</span> = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;Lock&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> lock = <span class="keyword">await</span> <span class="title class_">Lock</span>.<span class="title function_">deploy</span>(unlockTime, &#123;</span><br><span class="line">            <span class="attr">value</span>: lockedAmount</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="title function_">expect</span>(<span class="keyword">await</span> lock.<span class="title function_">unlockTime</span>()).<span class="property">to</span>.<span class="title function_">equal</span>(unlockTime);</span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>expect</code>：用于编写断言</li>
<li><code>hre</code>: hardhat runtime environment</li>
<li><code>hardhat-network-helper</code>: 与hardhat网络交互</li>
<li><code>describe</code>: <code>Mocha</code>的全局变量，用于描述和对测试分组</li>
<li><code>it</code>: <code>Mocha</code>的全局变量，用于描述和对测试分组</li>
</ul>
<p>测试本体位于<code>it</code>函数中。</p>
<p>在上述测试模块中，<code>lockedAmount</code>是用于在合约中锁住的金额(单位为wei)，<code>unlockTime</code>是解锁的时间。<code>time.latest</code>是一个返回最新挖到的块的时间戳。使用 <code>hre.ethers.getContractFactory</code>获取Lock合约，然后将合约部署，同时将<code>unlockTime</code>作为参数传递给它的构造函数，并向之传递交易的一些参数，包括通过 <code>value</code> 表示的发送给合约的以太币。最后通过 <code>unlockTime()</code>获取合约内部的<code>unlockTime</code>并使用 <code>to.equal</code> 与上述设定的<code>unlockTime</code>对比。</p>
<p>其中所有的函数返回值均为Promise。</p>
<h4 id="测试会回滚的函数"><a href="#测试会回滚的函数" class="headerlink" title="测试会回滚的函数"></a>测试会回滚的函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function withdraw() public &#123;</span><br><span class="line">  require(block.timestamp &gt;= unlockTime, &quot;You can&#x27;t withdraw yet&quot;);</span><br><span class="line">  require(msg.sender == owner, &quot;You aren&#x27;t the owner&quot;);</span><br></pre></td></tr></table></figure>

<p>上述合约函数中存在回滚的条件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;Should revert with the right error if called to soon&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; lock, unlockTime &#125; = <span class="keyword">await</span> <span class="title function_">deployContract</span>();</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">expect</span>(lock.<span class="title function_">withdraw</span>()).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">revertedWith</span>(<span class="string">&quot;You can&#x27;t withdraw yet&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用 <code>to.be.revertedWith</code> 断言交易发生回滚，原因在<code>revertedWith</code> 中给出。</p>
<p>其中 <code>.to.be.revertedWith</code> 是 hardhat Chai Matchers插件中的一部分。</p>
<p>上述两个测试中，断言中的await位置不相同，原因是第一个目的是比较两个值是否相同，内部的await用于等待值的获取，第二个的整个断言都是异步的因为必须等待交易被挖完矿，这意味着expect返回了一个promise。</p>
<h4 id="使用不同的地址"><a href="#使用不同的地址" class="headerlink" title="使用不同的地址"></a>使用不同的地址</h4><p>默认情况下部署和函数调用会使用配置的第一个账户。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&quot;Should revert with the right error if called from another account&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...deploy the contract...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [owner, otherAccount] = <span class="keyword">await</span> ethers.<span class="title function_">getSigners</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we increase the time of the chain to pass the first check</span></span><br><span class="line">  <span class="keyword">await</span> time.<span class="title function_">increaseTo</span>(unlockTime);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We use lock.connect() to send a transaction from another account</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(lock.<span class="title function_">connect</span>(otherAccount).<span class="title function_">withdraw</span>()).<span class="property">to</span>.<span class="property">be</span>.<span class="title function_">revertedWith</span>(</span><br><span class="line">    <span class="string">&quot;You aren&#x27;t the owner&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>hre.ethers.getSigners()</code>返回了一个数组，包含所有配置过的账户。使用 <code>lock.connect</code>方法连接到不同的账户。</p>
<h4 id="Using-fixtures"><a href="#Using-fixtures" class="headerlink" title="Using fixtures"></a>Using fixtures</h4><p>使用<code>beforeEach</code>钩子处理重复逻辑</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Contract</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ethers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;Lock&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">lock</span>: <span class="title class_">Contract</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">unlockTime</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="keyword">let</span> lockedAmount = <span class="number">1_000_000_000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">ONE_YEAR_IN_SECS</span> = <span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">    unlockTime = (<span class="keyword">await</span> helpers.<span class="property">time</span>.<span class="title function_">latest</span>()) + <span class="variable constant_">ONE_YEAR_IN_SECS</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Lock</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;Lock&quot;</span>);</span><br><span class="line">    lock = <span class="keyword">await</span> <span class="title class_">Lock</span>.<span class="title function_">deploy</span>(unlockTime, &#123; <span class="attr">value</span>: lockedAmount &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;some test&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// use the deployed contract</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用 <code>helpers.loadFixture</code> 解决多个测试之间共享变量的问题。第一次执行<code>loadFixture</code>，fixture函数被执行。当第二次执行，<code>loadFixture</code> 会重置网络的状态到fixture执行后的状态而不是再次执行fixture，从而撤销过去测试修改的状态。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Lock&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deployOneYearLockFixture</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> lockedAmount = <span class="number">1_000_000_000</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="variable constant_">ONE_YEAR_IN_SECS</span> = <span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">const</span> unlockTime = (<span class="keyword">await</span> helpers.<span class="property">time</span>.<span class="title function_">latest</span>()) + <span class="variable constant_">ONE_YEAR_IN_SECS</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">Lock</span> = <span class="keyword">await</span> hre.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;Lock&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> lock = <span class="keyword">await</span> <span class="title class_">Lock</span>.<span class="title function_">deploy</span>(unlockTime, &#123;</span><br><span class="line">            <span class="attr">value</span>: lockedAmount</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            lock,</span><br><span class="line">            unlockTime,</span><br><span class="line">            lockedAmount</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">it</span>(<span class="string">&quot;Sould set the right unlockTime&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; lock, unlockTime &#125; = <span class="keyword">await</span> helpers.<span class="title function_">loadFixture</span>(deployOneYearLockFixture);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert that the value is correct</span></span><br><span class="line">        <span class="title function_">expect</span>(<span class="keyword">await</span> lock.<span class="title function_">unlockTime</span>()).<span class="property">to</span>.<span class="title function_">equal</span>(unlockTime);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p><code>npx hardhat node</code></p>
<blockquote>
<p>开启本地测试网，默认端口是8545</p>
<p>同时生成具有ether的账号，这些账号是在本地测试网开启时生成的，故每次开启的账号都会不同。</p>
</blockquote>
<p><code>npx hardhat run --network localhost &lt;deploy-script-path&gt;</code></p>
<blockquote>
<p>将合约部署在本地测试网</p>
</blockquote>
<p><code>npx hardhat console --network localhost</code></p>
<blockquote>
<p>开启与本地测试网交互的命令行</p>
</blockquote>
<p><code>npx hardhat coverage</code></p>
<blockquote>
<p>测试在项目中的覆盖度</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/" data-id="cli5d2ofn00010ohk0dc51ug1" data-title="Hardhat笔记" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ERC721项目开发样例" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/" class="article-date">
  <time class="dt-published" datetime="2023-05-25T15:11:11.000Z" itemprop="datePublished">2023-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/">ERC721简易项目开发Demo</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>整个项目涉及以下几个部分：</p>
<ul>
<li>hardhat: 用于部署与测试合约</li>
<li>web3js: 用于与合约交互</li>
<li>alchemy: 提供apiKey以及部分常用的查询API</li>
<li>solidity: 编写合约</li>
</ul>
<h2 id="项目框架"><a href="#项目框架" class="headerlink" title="项目框架"></a>项目框架</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><ul>
<li><code>contracts</code>: 合约源文件</li>
<li><code>test</code>: 合约测试脚本</li>
<li><code>scripts</code>: 部署以及合约交互脚本</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li><code>hardhat.config.ts</code>: hardhat 配置</li>
<li><code>config.json</code>: 其他配置</li>
</ul>
<h3 id="涉及第三方库"><a href="#涉及第三方库" class="headerlink" title="涉及第三方库"></a>涉及第三方库</h3><ul>
<li><code>@openzeppelin/contracts</code></li>
<li><code>hardhat</code></li>
<li><code>@nomicfoundation/hardhat-toolbox</code></li>
<li><code>@nomicfoundation/hardhat-chai-matchers</code></li>
<li><code>chai</code></li>
<li><code>web3</code></li>
<li><code>@nomiclabs/hardhat-ethers</code></li>
<li><code>ethers@^5.0.0</code></li>
</ul>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="config-json"><a href="#config-json" class="headerlink" title="config.json"></a><code>config.json</code></h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;APIKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;privateKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0x48c5c054fee936c953864af7e879fa7fafec9648b4466d4e67e0d58d3d748f0a&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;publicKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0x1f7D4B464dfde59A11A362ee8d094a6FA817f1ca&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;alchemyHTTPURL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://eth-sepolia.g.alchemy.com/v2/pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contractName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NFT&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contractAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;networkName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sepolia&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A ERC721-NFT Demo of NeWive&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="hardhat-config-ts"><a href="#hardhat-config-ts" class="headerlink" title="hardhat.config.ts"></a><code>hardhat.config.ts</code></h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HardhatUserConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;hardhat/config&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;./config.json&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入插件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-toolbox&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomiclabs/hardhat-ethers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-chai-matchers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认网络是localhost，无需额外配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">hardhatUserConfig</span>: <span class="title class_">HardhatUserConfig</span> = &#123;</span><br><span class="line">    <span class="attr">solidity</span>: <span class="string">&quot;0.8.18&quot;</span>,</span><br><span class="line">    <span class="attr">networks</span>: &#123;</span><br><span class="line">        <span class="string">&quot;sepolia&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">url</span>: config.<span class="property">alchemyHTTPURL</span>,</span><br><span class="line">            <span class="attr">accounts</span>: [config.<span class="property">privateKey</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> hardhatUserConfig;</span><br></pre></td></tr></table></figure>

<h3 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a><code>package.json</code></h3><p>在<code>package.json</code>中添加以下命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat compile&quot;</span><span class="punctuation">,</span> <span class="comment">// 编译</span></span><br><span class="line">    <span class="attr">&quot;deploy-local&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run scripts/deploy.ts --network localhost&quot;</span><span class="punctuation">,</span> <span class="comment">// 部署到本地测试网</span></span><br><span class="line">    <span class="attr">&quot;deploy-sepolia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run scripts/deploy.ts --network sepolia&quot;</span><span class="punctuation">,</span> <span class="comment">// 部署到sepolia测试网</span></span><br><span class="line">    <span class="attr">&quot;testnet&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat node&quot;</span><span class="punctuation">,</span>  <span class="comment">// 启动本地测试网</span></span><br><span class="line">    <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat console --network localhost&quot;</span>    <span class="comment">// 启动hardhat命令行,</span></span><br><span class="line">    <span class="attr">&quot;exec-local&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run --network localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exec-sepolia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat run --network sepolia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx hardhat test&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="合约部分"><a href="#合约部分" class="headerlink" title="合约部分"></a>合约部分</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.18;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract ERC721NFT is ERC721, ERC721Enumerable, ERC721URIStorage, Ownable &#123;</span><br><span class="line">    using Counters for Counters.Counter;</span><br><span class="line"></span><br><span class="line">    Counters.Counter private _tokenIDCounter;</span><br><span class="line">    uint256 private _tokenNumLimit;</span><br><span class="line">    string private _description;</span><br><span class="line"></span><br><span class="line">    event SafeMintReturnValue(uint256);</span><br><span class="line"></span><br><span class="line">    constructor(uint256 tokenNumLimit, string memory description) ERC721(&quot;ERC721NFT&quot;, &quot;Joy&quot;) &#123;</span><br><span class="line">        _tokenNumLimit = tokenNumLimit;</span><br><span class="line">        _description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function safeMint(address target, string memory tokenMetadataURI) public &#123;</span><br><span class="line">        require(_tokenIDCounter.current() &lt;= _tokenNumLimit, &quot;NFT number reaches the limit&quot;);</span><br><span class="line">        uint256 tokenID = _tokenIDCounter.current();</span><br><span class="line">        _tokenIDCounter.increment();</span><br><span class="line">        _safeMint(target, tokenID);</span><br><span class="line">        _setTokenURI(tokenID, tokenMetadataURI);</span><br><span class="line">        emit SafeMintReturnValue(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setDescription(string memory description) public onlyOwner &#123;</span><br><span class="line">        _description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 以下为父类要求实现的接口</span><br><span class="line"></span><br><span class="line">    function _beforeTokenTransfer(address from, address to, uint256 firstTokenID, uint batchSize) internal override(ERC721, ERC721Enumerable) &#123;</span><br><span class="line">        super._beforeTokenTransfer(from, to, firstTokenID, batchSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(uint256 tokenID) internal override(ERC721, ERC721URIStorage) &#123;</span><br><span class="line">        super._burn(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function supportsInterface(bytes4 interfaceID) public view override(ERC721, ERC721Enumerable, ERC721URIStorage) returns (bool) &#123;</span><br><span class="line">        return super.supportsInterface(interfaceID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function tokenURI(uint256 tokenID) public view override(ERC721, ERC721URIStorage) returns (string memory) &#123;</span><br><span class="line">        return super.tokenURI(tokenID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hardhat-部署脚本"><a href="#hardhat-部署脚本" class="headerlink" title="hardhat 部署脚本"></a>hardhat 部署脚本</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hardhat <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs/promises&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Config</span>&#125; <span class="keyword">from</span> <span class="string">&quot;./type&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> configPath = path.<span class="title function_">resolve</span>(<span class="string">&quot;./config.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultConfig = &#123;</span><br><span class="line">    <span class="string">&quot;APIKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;privateKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;publicKey&quot;</span>: <span class="string">&quot;114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;alchemyHTTPURL&quot;</span>: <span class="string">&quot;https://eth-sepolia.g.alchemy.com/v2/114514&quot;</span>,</span><br><span class="line">    <span class="string">&quot;contractName&quot;</span>: <span class="string">&quot;NFT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;contractAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;networkName&quot;</span>: <span class="string">&quot;sepolia&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A ERC721-NFT Demo of NeWive&quot;</span>,</span><br><span class="line">    <span class="string">&quot;limit&quot;</span>: <span class="number">10</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">readConfig</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Config</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>((<span class="keyword">await</span> fs.<span class="title function_">readFile</span>(configPath)).<span class="title function_">toString</span>()) <span class="keyword">as</span> <span class="title class_">Config</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`采用默认配置: <span class="subst">$&#123;defaultConfig&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateContractAddress</span>(<span class="params">config: Config, address: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        config.<span class="property">contractAddress</span> = address;</span><br><span class="line">        <span class="keyword">await</span> fs.<span class="title function_">writeFile</span>(configPath, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deploy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> config = <span class="keyword">await</span> <span class="title function_">readConfig</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ERC721NFTContractFactory</span> = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;ERC721NFT&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> contractInstance = <span class="keyword">await</span> <span class="title class_">ERC721NFTContractFactory</span>.<span class="title function_">deploy</span>(config.<span class="property">limit</span>, config.<span class="property">description</span>);</span><br><span class="line">    <span class="keyword">await</span> contractInstance.<span class="title function_">deployed</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract deployed at address: <span class="subst">$&#123;contractInstance.address&#125;</span>, owner: <span class="subst">$&#123;<span class="keyword">await</span> contractInstance.signer.getAddress()&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">await</span> <span class="title function_">updateContractAddress</span>(config, contractInstance.<span class="property">address</span>)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Contract address updated successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">deploy</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Deployed Succeeded&quot;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>完成后执行向本地测试网部署命令<code>npm run deploy-local</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_1.png" class="" title="Alchemy日志">

<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/deploy_2.png" class="" title="Etherscan-Sepolia日志">

<h2 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">import hardhat from &quot;hardhat&quot;;</span><br><span class="line">import chai from &quot;chai&quot;;</span><br><span class="line">import config from &quot;../config.json&quot;;</span><br><span class="line">import &#123;expect&#125; from &quot;chai&quot;;</span><br><span class="line"></span><br><span class="line">describe(&quot;ERC721MFT&quot;, function () &#123;</span><br><span class="line">    before(async function () &#123;</span><br><span class="line">        this.Contract = await hardhat.ethers.getContractFactory(&quot;ERC721NFT&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    beforeEach(async function () &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.contract = await this.Contract.deploy(config.limit, config.description);</span><br><span class="line">            await this.contract.deployed();</span><br><span class="line">            const signers = await hardhat.ethers.getSigners();</span><br><span class="line">            this.owner = signers.splice(0,1)[0];</span><br><span class="line">            this.collector = signers;</span><br><span class="line">            this.mintCount = 3;</span><br><span class="line">            this.tokenID = [];</span><br><span class="line">            let p = [];</span><br><span class="line">            for(let i = 0; i &lt; this.mintCount; ++i) &#123;</span><br><span class="line">                p.push(this.contract.safeMint(this.collector[i].address, i.toString()));</span><br><span class="line">                this.tokenID.push(i);</span><br><span class="line">            &#125;</span><br><span class="line">            await Promise.all(p);</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">            console.log(e);</span><br><span class="line">            process.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;Contract Name: ERC721&quot;, async function () &#123;</span><br><span class="line">        expect(await this.contract.name()).to.equal(&quot;ERC721NFT&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&#x27;合约的Symbol为Joy&#x27;, async function () &#123;</span><br><span class="line">        expect(await this.contract.symbol()).to.equal(&quot;Joy&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;合约拥有者能正确对应&quot;, async function() &#123;</span><br><span class="line">        for(let i = 0; i &lt; this.mintCount; ++i) &#123;</span><br><span class="line">            expect(await this.contract.ownerOf(this.tokenID[i])).to.equal(this.collector[i].address);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以遍历NFT个数&quot;, async function () &#123;</span><br><span class="line">        console.log(this.tokenID.length);</span><br><span class="line">        expect((await this.contract.balanceOf(this.collector[0].address)).toString()).to.equal(&quot;1&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以铸造新的NFT&quot;, async function () &#123;</span><br><span class="line">        const nTokenID = this.tokenID.length;</span><br><span class="line">        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);</span><br><span class="line">        expect(await this.contract.ownerOf(nTokenID)).to.equal(this.collector[nTokenID].address);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;触发SafeMintReturnValue事件&quot;, async function () &#123;</span><br><span class="line">        const nTokenID = this.tokenID.length;</span><br><span class="line">        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);</span><br><span class="line">        expect(await this.contract.ownerOf(nTokenID))</span><br><span class="line">            .to</span><br><span class="line">            .emit(this.contract, &quot;SafeMintReturnValue&quot;)</span><br><span class="line">            .withArgs(nTokenID);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;只能铸造一定次数的NFT&quot;, async function () &#123;</span><br><span class="line">        for(let i = 3; i &lt;= 10; ++i) &#123;</span><br><span class="line">            await this.contract.safeMint(this.collector[i].address, i);</span><br><span class="line">        &#125;</span><br><span class="line">        await expect(this.contract.safeMint(this.collector[11].address, &quot;11&quot;))</span><br><span class="line">            .to</span><br><span class="line">            .be</span><br><span class="line">            .revertedWith(&quot;NFT number reaches the limit&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&#x27;可以正确展示合约描述&#x27;, async function () &#123;</span><br><span class="line">        expect(await this.contract.getDescription())</span><br><span class="line">            .to</span><br><span class="line">            .equal(config.description);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    it(&quot;可以修改合约描述&quot;, async function () &#123;</span><br><span class="line">        await this.contract.setDescription(&quot;114514&quot;);</span><br><span class="line">        expect(await this.contract.getDescription())</span><br><span class="line">            .to</span><br><span class="line">            .equal(&quot;114514&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行<code>npm run test</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/test_1.png" class="" title="测试输出">

<h2 id="交互脚本"><a href="#交互脚本" class="headerlink" title="交互脚本"></a>交互脚本</h2><p>此处提供三种可选的交互方式，包括</p>
<ul>
<li>hardhat</li>
<li>web3js</li>
<li>alchemy-sdk</li>
</ul>
<h3 id="基于hardhat"><a href="#基于hardhat" class="headerlink" title="基于hardhat"></a>基于hardhat</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// integrateByHardhat.ts</span></span><br><span class="line"><span class="keyword">import</span> hardhat <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateByHardhat</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 链接合约</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Contract</span> = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getContractFactory</span>(<span class="string">&quot;ERC721NFT&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> contract = <span class="keyword">await</span> <span class="title class_">Contract</span>.<span class="title function_">attach</span>(config.<span class="property">contractAddress</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 合约信息</span></span><br><span class="line">    <span class="keyword">const</span> name = <span class="keyword">await</span> contract.<span class="title function_">name</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">symbol</span> = <span class="keyword">await</span> contract.<span class="title function_">symbol</span>();</span><br><span class="line">    <span class="keyword">const</span> description = <span class="keyword">await</span> contract.<span class="title function_">getDescription</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract name: <span class="subst">$&#123;name&#125;</span>, Contract symbol: <span class="subst">$&#123;<span class="built_in">symbol</span>&#125;</span>, Description: <span class="subst">$&#123;description&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户信息</span></span><br><span class="line">    <span class="keyword">const</span> signers = <span class="keyword">await</span> hardhat.<span class="property">ethers</span>.<span class="title function_">getSigners</span>();</span><br><span class="line">    <span class="keyword">const</span> owner = signers.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract Owner: <span class="subst">$&#123;owner.address&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> collectors = signers.<span class="title function_">map</span>(<span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">address</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Contract Collectors: <span class="subst">$&#123;collectors.join(<span class="string">&quot;,&quot;</span>)&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 铸币</span></span><br><span class="line">    contract.<span class="title function_">once</span>(<span class="string">&quot;SafeMintReturnValue&quot;</span>, <span class="function">(<span class="params">tokenID</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`铸币成功，tokenID为<span class="subst">$&#123;tokenID&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> tx = (<span class="keyword">await</span> contract.<span class="title function_">safeMint</span>(owner.<span class="property">address</span>, <span class="string">&quot;ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF&quot;</span>));</span><br><span class="line">    <span class="keyword">await</span> tx.<span class="title function_">wait</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// owner拥有的NFT数量</span></span><br><span class="line">    <span class="keyword">const</span> balanceOfOwner = <span class="keyword">await</span> contract.<span class="title function_">balanceOf</span>(owner.<span class="property">address</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The balance of the owner: <span class="subst">$&#123;balanceOfOwner&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改信息</span></span><br><span class="line">    <span class="keyword">const</span> tx1 = <span class="keyword">await</span> contract.<span class="title function_">setDescription</span>(<span class="string">`<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleDateString()&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">await</span> tx1.<span class="title function_">wait</span>();</span><br><span class="line">    <span class="keyword">const</span> nDescription = <span class="keyword">await</span> contract.<span class="title function_">getDescription</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(nDescription);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateByHardhat</span>();</span><br></pre></td></tr></table></figure>

<p>其中涉及修改链上状态的方法例如<code>safeMint</code>以及<code>setDescription</code>都需要使用wait等待交易被确认。<br>执行<code>npm run exec-sepolia ./scripts/integrateByHardhat.ts</code>。</p>
<img src="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/hardhat_1.png" class="" title="hardhat输出">

<h3 id="基于web3js"><a href="#基于web3js" class="headerlink" title="基于web3js"></a>基于web3js</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Web3</span> <span class="keyword">from</span> <span class="string">&quot;web3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> contractArtifacts <span class="keyword">from</span> <span class="string">&quot;../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">AbiItem</span>&#125; <span class="keyword">from</span> <span class="string">&quot;web3-utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TransactionConfig</span>, <span class="title class_">EventLog</span>&#125; <span class="keyword">from</span> <span class="string">&quot;web3-core&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateByWeb3</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 将alchemyHTTP作为Provider传递给Web3</span></span><br><span class="line">    <span class="keyword">const</span> alchemy = <span class="keyword">new</span> <span class="title class_">Web3</span>(config.<span class="property">alchemyHTTPURL</span>);</span><br><span class="line">    <span class="comment">// 添加一个钱包账号</span></span><br><span class="line">    <span class="keyword">const</span> account = alchemy.<span class="property">eth</span>.<span class="property">accounts</span>.<span class="property">wallet</span>.<span class="title function_">add</span>(config.<span class="property">privateKey</span>);</span><br><span class="line">    <span class="comment">// 创建一个合约实例</span></span><br><span class="line">    <span class="keyword">const</span> contract = <span class="keyword">new</span> alchemy.<span class="property">eth</span>.<span class="title class_">Contract</span>(contractArtifacts.<span class="property">abi</span> <span class="keyword">as</span> <span class="title class_">Array</span>&lt;<span class="title class_">AbiItem</span>&gt;, config.<span class="property">contractAddress</span>);</span><br><span class="line">    <span class="comment">// 事件监听</span></span><br><span class="line">    <span class="keyword">const</span> safeMintEventListener = <span class="keyword">await</span> contract</span><br><span class="line">        .<span class="property">events</span></span><br><span class="line">        .<span class="title class_">SafeMintReturnValue</span>(&#123;</span><br><span class="line">            <span class="attr">filter</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">fromBlock</span>: <span class="string">&quot;latest&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建交易， works</span></span><br><span class="line">    <span class="comment">// safeMintEventListener.on(&quot;data&quot;, (e:EventLog) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(e.returnValues);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// safeMintEventListener.on(&quot;connected&quot;, function(subscriptionId: EventLog)&#123;</span></span><br><span class="line">    <span class="comment">//     console.log(subscriptionId);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="keyword">const</span> gasPrice = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getGasPrice</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">tx</span>: <span class="title class_">TransactionConfig</span> = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        gasPrice,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getTransactionCount</span>(config.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="attr">data</span>: contract.<span class="property">methods</span>.<span class="title function_">safeMint</span>(config.<span class="property">publicKey</span>, <span class="string">&quot;ipfs://1145141910811&quot;</span>).<span class="title function_">encodeABI</span>(),</span><br><span class="line">        <span class="attr">gas</span>: <span class="number">210000</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 发送交易，如果该交易是通过一个存在的账号发送则会自动签署</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">sendTransaction</span>(tx);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过签署交易然后发送</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> contract.<span class="property">methods</span>.<span class="title function_">getDescription</span>().<span class="title function_">call</span>());</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">tx1</span>: <span class="title class_">TransactionConfig</span> = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        gasPrice,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">getTransactionCount</span>(config.<span class="property">publicKey</span>),</span><br><span class="line">        <span class="attr">data</span>: contract.<span class="property">methods</span>.<span class="title function_">setDescription</span>(<span class="string">&quot;你是一个一个一个&quot;</span>).<span class="title function_">encodeABI</span>(),</span><br><span class="line">        <span class="attr">gas</span>: <span class="number">210000</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> signedTX = <span class="keyword">await</span> account.<span class="title function_">signTransaction</span>(tx1);</span><br><span class="line">    <span class="keyword">const</span> res1 = <span class="keyword">await</span> alchemy.<span class="property">eth</span>.<span class="title function_">sendSignedTransaction</span>(signedTX.<span class="property">rawTransaction</span> <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res1);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> contract.<span class="property">methods</span>.<span class="title function_">getDescription</span>().<span class="title function_">call</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Not Work, 只获取到返回值而sepolia etherscan中没有mint记录，call不会改变链上的状态</span></span><br><span class="line">    <span class="comment">// const tx = await contract.methods.safeMint(config.publicKey, &quot;ipfs://1145141910811&quot;).call();</span></span><br><span class="line">    <span class="comment">// console.log(tx);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateByWeb3</span>();</span><br></pre></td></tr></table></figure>

<p>其中未解决发送交易调用函数的返回值与事件监听的问题。</p>
<h3 id="基于alchemy-sdk"><a href="#基于alchemy-sdk" class="headerlink" title="基于alchemy-sdk"></a>基于alchemy-sdk</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Network</span>, <span class="title class_">Utils</span>, <span class="title class_">Wallet</span>, <span class="title class_">Alchemy</span>&#125; <span class="keyword">from</span> <span class="string">&quot;alchemy-sdk&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&quot;../config.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> contractArtifacts <span class="keyword">from</span> <span class="string">&quot;../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">TransactionRequest</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@ethersproject/providers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">&quot;ethers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> settings = &#123;</span><br><span class="line">    <span class="attr">apiKey</span>: config.<span class="property">APIKey</span>,</span><br><span class="line">    <span class="attr">network</span>: <span class="title class_">Network</span>.<span class="property">ETH_SEPOLIA</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">FunctionName</span> &#123;</span><br><span class="line">    [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> web3 = <span class="keyword">new</span> <span class="title class_">Alchemy</span>(settings);</span><br><span class="line"><span class="keyword">const</span> wallet = <span class="keyword">new</span> <span class="title class_">Wallet</span>(config.<span class="property">privateKey</span>, web3);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">integrateAlchemySDK</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获取给出地址的所有的NFT</span></span><br><span class="line">    <span class="keyword">const</span> allNFTs = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getNftsForOwner</span>(config.<span class="property">publicKey</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(allNFTs);</span><br><span class="line">    <span class="comment">// // 根据tokenID获取Owner</span></span><br><span class="line">    <span class="keyword">const</span> owner = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getOwnersForNft</span>(config.<span class="property">contractAddress</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(owner);</span><br><span class="line">    <span class="comment">// // 根据合约获取所有owner</span></span><br><span class="line">    <span class="keyword">const</span> owners = <span class="keyword">await</span> web3.<span class="property">nft</span>.<span class="title function_">getOwnersForContract</span>(config.<span class="property">contractAddress</span>, &#123;</span><br><span class="line">        <span class="attr">withTokenBalances</span>: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(owners);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用会改变链上状态的方法</span></span><br><span class="line">    <span class="comment">// 解析ABI</span></span><br><span class="line">    <span class="keyword">const</span> contractInterface = <span class="keyword">new</span> <span class="title class_">Utils</span>.<span class="title class_">Interface</span>(contractArtifacts.<span class="property">abi</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">functionName</span>: <span class="title class_">FunctionName</span> = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> contractInterface.<span class="property">functions</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(contractInterface.<span class="property">functions</span>, k)) &#123;</span><br><span class="line">            functionName[contractInterface.<span class="property">functions</span>[k].<span class="property">name</span> <span class="keyword">as</span> <span class="built_in">string</span>] = k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对方法进行ABI编码</span></span><br><span class="line">    <span class="keyword">const</span> safeMintEncoded = contractInterface.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;safeMint&quot;</span>, [config.<span class="property">publicKey</span>, <span class="string">&quot;ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF&quot;</span>])</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(safeMintEncoded);</span><br><span class="line">    <span class="comment">// 获取nonce</span></span><br><span class="line">    <span class="keyword">const</span> nonce = <span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getTransactionCount</span>(</span><br><span class="line">        wallet.<span class="property">address</span>,</span><br><span class="line">        <span class="string">&quot;latest&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 获取gasPrice，是必要的一步，不获取会抛出Transaction Underpriced错误</span></span><br><span class="line">    <span class="keyword">const</span> gasPrice = (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getFeeData</span>()).<span class="property">gasPrice</span>;</span><br><span class="line">    <span class="keyword">const</span> transaction = &#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">gasLimit</span>: <span class="number">21000000</span>,</span><br><span class="line">        <span class="attr">data</span>: safeMintEncoded,</span><br><span class="line">        nonce,</span><br><span class="line">        gasPrice</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> signedTransact = <span class="keyword">await</span> wallet.<span class="title function_">signTransaction</span>(transaction <span class="keyword">as</span> <span class="title class_">TransactionRequest</span>);</span><br><span class="line">    <span class="keyword">const</span> sentTX = <span class="keyword">await</span> (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">sendTransaction</span>(signedTransact)).<span class="title function_">wait</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(sentTX);</span><br><span class="line">    <span class="comment">// 获取事件日志</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SafeMintReturnValue</span> = contractInterface.<span class="title function_">encodeFilterTopics</span>(<span class="string">&quot;SafeMintReturnValue&quot;</span>, []);</span><br><span class="line">    <span class="keyword">const</span> logs = <span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">getLogs</span>(&#123;</span><br><span class="line">        <span class="attr">toBlock</span>: <span class="string">&quot;latest&quot;</span>,</span><br><span class="line">        <span class="attr">address</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">topics</span>: <span class="title class_">SafeMintReturnValue</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;日志: &quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(logs[<span class="number">0</span>].<span class="property">data</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// call不能调用改变链上状态的方法</span></span><br><span class="line">    <span class="keyword">const</span> messageABIEncoded = contractInterface.<span class="title function_">encodeFunctionData</span>(<span class="string">&quot;getDescription&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> resHex = (<span class="keyword">await</span> web3.<span class="property">core</span>.<span class="title function_">call</span>(&#123;</span><br><span class="line">        <span class="attr">from</span>: config.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">to</span>: config.<span class="property">contractAddress</span>,</span><br><span class="line">        <span class="attr">data</span>: messageABIEncoded,</span><br><span class="line">        <span class="attr">nonce</span>: <span class="keyword">await</span> wallet.<span class="title function_">getTransactionCount</span>()</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(resHex);</span><br><span class="line">    <span class="comment">// 解析字符串</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ethers.<span class="property">utils</span>.<span class="title function_">toUtf8String</span>(resHex));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">integrateAlchemySDK</span>();</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/" data-id="cli5d2ofj00000ohk696862c4" data-title="ERC721简易项目开发Demo" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ERC721/" rel="tag">ERC721</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/alchemy/" rel="tag">alchemy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web3js/" rel="tag">web3js</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ERC721" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/19/ERC721/" class="article-date">
  <time class="dt-published" datetime="2023-05-19T02:58:32.000Z" itemprop="datePublished">2023-05-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/19/ERC721/">ERC721</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>ERC-721是为NFT引入的标准。</p>
<p>非同质代币(NFT)是一种具有唯一性识别的代币 ，ERC-20 Token可以无限细分为10^18份，而ERC721的Token最小的单位为1，无法再分割。</p>
<p>由于ERC721代币具有唯一性，不可分割的特点，所以很容易和一些具体的物品关联起来，通过这样一个标准，可以更广泛的应用到实际场景中。</p>
<h2 id="标准"><a href="#标准" class="headerlink" title="标准"></a>标准</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">interface ERC721 &#123;</span><br><span class="line">    // 当任何NFT所有权更改时都会触发此事件，包括创建(from = 0)时和销毁(to = 0)时，合约创建时除外</span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 indexed _tokenId);</span><br><span class="line"></span><br><span class="line">    // 当更改或确认NFT的授权地址时触发。</span><br><span class="line">    // 零地址表示没有授权的地址。</span><br><span class="line">    // 发生 `Transfer` 事件时，同样表示该NFT的授权地址（如果有）被重置为“无”（零地址）。</span><br><span class="line">    event Approval(address indexed _owner, address indexed _approved, uint indexed _tokenId);</span><br><span class="line"></span><br><span class="line">    // 所有者启用或禁用操作员时触发。（操作员可管理所有者所持有的NFTs）</span><br><span class="line">    event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);</span><br><span class="line"></span><br><span class="line">    // @notice 统计所持有的NFTs数量</span><br><span class="line">    // @dev NFT 不能分配给零地址，查询零地址同样会异常</span><br><span class="line">    // @param _owner ： 待查地址</span><br><span class="line">    // @return 返回数量，也许是0</span><br><span class="line">    function balanceOf(address _owner) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    // @notice 返回所有者</span><br><span class="line">    // @dev NFT 不能分配给零地址，查询零地址抛出异常</span><br><span class="line">    // @param _tokenId NFT 的id</span><br><span class="line">    // @return 返回所有者地址</span><br><span class="line">    function ownerOf(uint256 _tokenId) external view returns (address);</span><br><span class="line"></span><br><span class="line">    // @notice 将NFT的所有权从一个地址转移到另一个地址</span><br><span class="line">    // @dev 如果`msg.sender` 不是当前的所有者（或授权者）抛出异常</span><br><span class="line">    // 如果 `_from` 不是所有者、`_to` 是零地址、`_tokenId` 不是有效id 均抛出异常。</span><br><span class="line">    //  当转移完成时，函数检查  `_to` 是否是合约，如果是，调用 `_to`的 `onERC721Received` 并且检查返回值是否是 `0x150b7a02` (即：`bytes4(keccak256(&quot;onERC721Received(address,address,uint256,bytes)&quot;))`)  如果不是抛出异常。</span><br><span class="line">    // @param _from ：当前的所有者</span><br><span class="line">    // @param _to ：新的所有者</span><br><span class="line">    // @param _tokenId ：要转移的token id.</span><br><span class="line">    // @param data : 附加额外的参数（没有指定格式），传递给接收者。</span><br><span class="line">    function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes data) external payable;</span><br><span class="line"></span><br><span class="line">    // @notice 将NFT的所有权从一个地址转移到另一个地址，功能同上，不带data参数。</span><br><span class="line">    function safeTransferFrom(address _from, address _to, uint256 _tokenId) external payable;</span><br><span class="line"></span><br><span class="line">    // @notice 转移所有权 -- 调用者负责确认`_to`是否有能力接收NFTs，否则可能永久丢失。</span><br><span class="line">    // @dev 如果`msg.sender` 不是当前的所有者（或授权者、操作员）抛出异常</span><br><span class="line">    // 如果 `_from` 不是所有者、`_to` 是零地址、`_tokenId` 不是有效id 均抛出异常。</span><br><span class="line">    function transferFrom(address _from, address _to, uint256 _tokenId) external payable;</span><br><span class="line"></span><br><span class="line">    // @notice 更改或确认NFT的授权地址</span><br><span class="line">    // @dev 零地址表示没有授权的地址。</span><br><span class="line">    //  如果`msg.sender` 不是当前的所有者或操作员</span><br><span class="line">    // @param _approved 新授权的控制者</span><br><span class="line">    // @param _tokenId ： token id</span><br><span class="line">    function approve(address _approved, uint256 _tokenId) external payable;</span><br><span class="line"></span><br><span class="line">    // @notice 启用或禁用第三方（操作员）管理 `msg.sender` 所有资产</span><br><span class="line">    // @dev 触发 ApprovalForAll 事件，合约必须允许每个所有者可以有多个操作员。</span><br><span class="line">    // @param _operator 要添加到授权操作员列表中的地址</span><br><span class="line">    // @param _approved True 表示授权, false 表示撤销</span><br><span class="line">    function setApprovalForAll(address _operator, bool _approved) external;</span><br><span class="line"></span><br><span class="line">    // @notice 获取单个NFT的授权地址</span><br><span class="line">    // @dev 如果 `_tokenId` 无效，抛出异常。</span><br><span class="line">    // @param _tokenId ：  token id</span><br><span class="line">    // @return 返回授权地址， 零地址表示没有。</span><br><span class="line">    function getApproved(uint256 _tokenId) external view returns (address);</span><br><span class="line"></span><br><span class="line">    // @notice 查询一个地址是否是另一个地址的授权操作员</span><br><span class="line">    // @param _owner 所有者</span><br><span class="line">    // @param _operator 代表所有者的授权操作员</span><br><span class="line">    function isApprovedForAll(address _owner, address _operator) external view returns (bool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="扩展接口"><a href="#扩展接口" class="headerlink" title="扩展接口"></a>扩展接口</h2><h3 id="接受安全转账接口"><a href="#接受安全转账接口" class="headerlink" title="接受安全转账接口"></a>接受安全转账接口</h3><p>如果合约（应用）要接受NFT的安全转账，则必须实现如下接口:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface ERC721TokenReceiver &#123;</span><br><span class="line">    // @notice 处理接收NFT</span><br><span class="line">    // @dev ERC721智能合约在`transfer`完成后，在接收这地址上调用这个函数。</span><br><span class="line">    // 函数可以通过revert 拒绝接收。返回非`0x150b7a02` 也同样是拒绝接收。</span><br><span class="line">    // 注意: 调用这个函数的 msg.sender是ERC721的合约地址</span><br><span class="line">    // @param _operator ：调用 `safeTransferFrom` 函数的地址。</span><br><span class="line">    // @param _from ：之前的NFT拥有者</span><br><span class="line">    // @param _tokenId ： NFT token id</span><br><span class="line">    // @param _data ： 附加信息</span><br><span class="line">    // @return 正确处理时返回 `bytes4(keccak256(&quot;onERC721Received(address,address,uint256,bytes)&quot;))`</span><br><span class="line">    function onERC721Received(address _operator, address _from, uint256 _tokenId, bytes _data) external returns(bytes4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="元数据接口"><a href="#元数据接口" class="headerlink" title="元数据接口"></a>元数据接口</h3><p>元数据包括一个名称和符号，就像它许多其他代币标准中一样（如ERC-20）。 此外，还可以为一个代币定义tokenURI ， 每个代币都应该有自己的URI。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface ERC721Metadata &#123;</span><br><span class="line">    // @notice NFTs 集合的名字</span><br><span class="line">    function name() external view returns (string _name);</span><br><span class="line"></span><br><span class="line">    // @notice NFTs 缩写代号</span><br><span class="line">    function symbol() external view returns (string _symbol);</span><br><span class="line"></span><br><span class="line">    // @notice 一个给定资产的唯一的统一资源标识符(URI)</span><br><span class="line">    // @dev 如果 `_tokenId` 无效，抛出异常. URIs在 RFC 3986 定义，</span><br><span class="line">    // URI 也许指向一个 符合 &quot;ERC721 元数据 JSON Schema&quot; 的 JSON 文件</span><br><span class="line">    function tokenURI(uint256 _tokenId) external view returns (string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="枚举接口"><a href="#枚举接口" class="headerlink" title="枚举接口"></a>枚举接口</h3><p>枚举接口包含了按索引获取到对应的代币，可以提供NFTs的完整列表，以便NFT可被发现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interface ERC721Enumerable &#123;</span><br><span class="line">    // @notice  NFTs 计数</span><br><span class="line">    // @return  返回合约有效跟踪（所有者不为零地址）的 NFT数量</span><br><span class="line">    function totalSupply() external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    // @notice 枚举索引NFT</span><br><span class="line">    // @dev 如果 `_index` &gt;= `totalSupply()` 则抛出异常</span><br><span class="line">    // @param _index 小于 `totalSupply()`的索引号</span><br><span class="line">    // @return 对应的token id（标准不指定排序方式)</span><br><span class="line">    function tokenByIndex(uint256 _index) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    // @notice 枚举索引某个所有者的 NFTs</span><br><span class="line">    // @dev  如果 `_index` &gt;= `balanceOf(_owner)` 或 `_owner` 是零地址，抛出异常</span><br><span class="line">    // @param _owner 查询的所有者地址</span><br><span class="line">    // @param _index 小于 `balanceOf(_owner)` 的索引号</span><br><span class="line">    // @return 对应的token id （标准不指定排序方式)</span><br><span class="line">    function tokenOfOwnerByIndex(address _owner, uint256 _index) external view returns (uint256);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/19/ERC721/" data-id="cli5d2ofp00030ohkfub95j7b" data-title="ERC721" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFT/" rel="tag">NFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity智能合约基本概念" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T06:30:56.000Z" itemprop="datePublished">2023-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">Solidity智能合约基本概念</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>智能合约（smart contract）的定义如下：</p>
<p>智能合约是一种旨在以信息化方式传播、验证或执行合同的计算机协议，它允许在没有第三方的情况下进行可信交易。这些交易可追踪且不可逆转。</p>
<p>以太坊中最大特点是引入了智能合约，智能合约运行平台为脚本提供了更加丰富的表现力，为区块链的应用场景增加了无限的可能性。</p>
<h2 id="以太坊账户"><a href="#以太坊账户" class="headerlink" title="以太坊账户"></a>以太坊账户</h2><ul>
<li>外部账户(EOA): 普通用户持有的账户，它的地址由公钥确定，通过公私钥对生成。</li>
<li>合约账户(CA): 合约账户中除了存储代码（编译后的字节码），其他功能与外部账户完全一样。</li>
</ul>
<p>合约账户由外部账户调用，之后合约账户也可继续调用合约账户。也就是合约账户最初始只能是外部账户来调用。</p>
<h2 id="gas"><a href="#gas" class="headerlink" title="gas"></a>gas</h2><p>在以太坊中引入了汽油费（Gas）的概念，引入的目的是执行智能合约中可能消耗的资源会很大，所以需要收取交易发起人的汽油费。</p>
<p>GasLimit为最大汽油费，当一个全节点收到对智能合约的调用时会先按照最大汽油费一次性从账户扣除掉，再根据实际情况，若最后合约执行完毕有多余的汽油费将退回，若汽油费不够，智能合约将状态回滚，并且汽油费不会退回。</p>
<h2 id="NFT-概述"><a href="#NFT-概述" class="headerlink" title="NFT 概述"></a>NFT 概述</h2><p>一个token是区块链中某个事物的代表。通过将这些事物以token作为代表，可以允许其在智能合约中流通。</p>
<p>一个token合约本质是一个以太坊智能合约，发送token即为调用合约中的一个方法。</p>
<p>NFT(Non-fungible tokens)是用于提供所有权证明的加密的独一无二的代币。</p>
<p>NFT是包含有记录于*智能合同(smart contract)*中的身份识别信息的数字资源。记录于智能合同中的信息是对NFT唯一性的保证。其中不可替代性(Non-fungible)即代币不可被直接替换为另一个代币，也不能将两个NFT交换，因为两个NFT之间不具有相似性。</p>
<p>比特币是一种可替换的代币，比特币也可以划分为更小单位的比特币的集合，类比不同面值的人民币。因此<em>可替代的货币是可分割的，不可替代的货币是不可分割的</em>。</p>
<p>OpenSea、Rarible是NFT领域主要的交易渠道。</p>
<p>NFT和对应的智能合同允许包含更详细的属性，比如拥有者的身份、丰富的元数据或重要的文件链接。</p>
<p>NFT、相应的协议和智能合约依然处于开发状态。搭建用于管理和创建NFT的应用和平台依旧相对复杂。</p>
<p>NFT为安全令牌的创建和数字以及现实世界的资源的代币化提供了可能。实物的资源比如财产可以被标记为部分或共享所有权。如果这些安全令牌是不可替代的，那这些资源的所有权完全可追溯，即使代币代表的部分拥有权被售卖。</p>
<p>NFT在IP Rights(Copyrights、Trademarks、Patents、TradeSecrets)中一般指Copyrights。</p>
<p>NFT中的token绑定了唯一一个uri，也就是metadata的链接。在metadata中会进一步包含一个资源的URI，这个url可以是图片都，也可以是video的。从技术层面来 讲，这是一个非常普通的token，代码非常简单，NFT是建立在区块链之上的，是智能合约成就了NFT，而不是NFT本身有多么复杂。</p>
<h2 id="智能合约运行流程"><a href="#智能合约运行流程" class="headerlink" title="智能合约运行流程"></a>智能合约运行流程</h2><p>1.编写智能合约代码，并编译成字节码。</p>
<p>2.部署智能合约。过程是向“0”地址发送一笔带有智能合约字节码数据的交易，这个交易会生成该智能合约的地址，并将字节码存储在该地址下的状态树中。</p>
<p>3.执行智能合约（调用智能合约函数）。向智能合约地址发送一个交易，该交易携带被调用的智能合约函数信息及调用参数，携带的信息遵循ABI编码协议。</p>
<p>4.智能合约地址收到这样的调用合约函数的交易，首先会解码数据，根据结果查找到对应函数的入口，再传入参数执行该函数。</p>
<p>5.执行函数的过程是状态转换的过程，执行完成后会扣除调用者相应的Gas花费。</p>
<p>6.状态转换的过程会全网同步并被再次执行验证，确保执行结果一致，这样通过验证后的交易会记录到区块中，同时更新状态数据。</p>
<h2 id="NFT-Metadata"><a href="#NFT-Metadata" class="headerlink" title="NFT Metadata"></a>NFT Metadata</h2><p>为了让 OpenSea 为 ERC721 代币提取链下元数据，合约需要返回一个指向托管元数据的 URI。为了找到这个 URI，OpenSea、Rarible 和其他流行的市场将使用 ERC721URIStorage 标准中包含的 tokenURI 方法。</p>
<p>ERC721 中的 tokenURI 函数应该返回一个 HTTP 或 IPFS URL，例如 ipfs:&#x2F;&#x2F;bafkreig4rdq3nvyg2yra5x363gdo4xtbcfjlhshw63we7vtlldyyvwagbq。查询时，此 URL 应返回一个 JSON 数据块，其中包含token的元数据。</p>
<p>根据OpenSea的文档，NFT Metadata应该按照如下格式存储</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR DESCRIPTION&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;external_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YOUR URL&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IMAGE URL&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TITLE&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Base&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Starfish&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Eyes&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Big&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mouth&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Surprised&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Level&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Stamina&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1.4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Personality&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sad&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;display_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boost_number&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Aqua Power&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">40</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;display_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boost_percentage&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Stamina Increase&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;display_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;trait_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Generation&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" data-id="cli5d2og000120ohk2led9wdd" data-title="Solidity智能合约基本概念" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NFT/" rel="tag">NFT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity合约安全" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/17/Solidity%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T02:13:49.000Z" itemprop="datePublished">2023-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/17/Solidity%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/">Solidity合约安全</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="重入"><a href="#重入" class="headerlink" title="重入"></a>重入</h2><p>合约 (A) 与另一个合约 (B) 的任何交互以及以太币的任何转移都会将控制权移交给该合约 (B)。这使得 B 可以在此交互完成之前回调 A。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.6.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">// 包含bug的合约</span><br><span class="line">contract Fund &#123;</span><br><span class="line">    mapping(address =&gt; uint) shares;</span><br><span class="line">    </span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        if (payable(msg.sender).send(shares[msg.sender]))</span><br><span class="line">            shares[msg.sender] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ether 传输总是可以包括代码执行，因此接收者可以是一个调用撤回的合约。</p>
<p>上述代码造成的危害较小，因为send对gas消耗的限制。但如果使用call则会使攻击者获取多次退款，因为call默认会转发所有gas。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.6.2 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract Fund &#123;</span><br><span class="line">    mapping(address =&gt; uint) shares;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        (bool success,) = msg.sender.call&#123;value: shares[msg.sender]&#125;(&quot;&quot;);</span><br><span class="line">        if (success)</span><br><span class="line">            shares[msg.sender] = 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中攻击者可以回调发送合同的函数，因而可以多次调用withdraw而在call未执行完时shares不会更新，从而实现hack的目的。</p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><ul>
<li>优先更新shares</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.6.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract Fund &#123;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint) shares;</span><br><span class="line"></span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        uint share = shares[msg.sender];</span><br><span class="line">        shares[msg.sender] = 0;</span><br><span class="line">        payable(msg.sender).transfer(share);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将withdraw的过程整合为一个原子操作，加锁</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">contract Locker &#123;</span><br><span class="line">    bool private locked = false;</span><br><span class="line"></span><br><span class="line">    modifier lock() &#123;</span><br><span class="line">        require(</span><br><span class="line">            !locked,</span><br><span class="line">            &quot;Reentrant call.&quot;</span><br><span class="line">        );</span><br><span class="line">        locked = true;</span><br><span class="line">        _;</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Fund is Locker &#123;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint) shares;</span><br><span class="line"></span><br><span class="line">    function withdraw() public lock &#123;</span><br><span class="line">        uint share = shares[msg.sender];</span><br><span class="line">        shares[msg.sender] = 0;</span><br><span class="line">        payable(msg.sender).transfer(share);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是上锁之后不会对后续请求进行排队。</p>
<h2 id="循环与gas限制"><a href="#循环与gas限制" class="headerlink" title="循环与gas限制"></a>循环与gas限制</h2><p>如果循环的结束条件是根据变量决定的，则循环次数不确定，有可能导致消耗过量的gas。</p>
<h2 id="发送和接收ether"><a href="#发送和接收ether" class="headerlink" title="发送和接收ether"></a>发送和接收ether</h2><p>如果一个合约在没有函数被调用的情况下接收ether，则receive或者fallback函数将被调用。如果合约中没有这两个函数的实现则ether将被拒绝。</p>
<p>在调用上述两个函数的过程中，合约只能依靠当时可用的“gas 津贴”（2300 gas）。这个津贴不足以修改storage，为了确保能够在上述情况下顺利接受ether需要确保receive与fallback对gas的要求。</p>
<p>尽可能使用最精确的单位来表示 Wei 数量，因为会丢失任何因缺乏精度而四舍五入的单位。</p>
<h3 id="使用transfer时需要注意的内容"><a href="#使用transfer时需要注意的内容" class="headerlink" title="使用transfer时需要注意的内容"></a>使用transfer时需要注意的内容</h3><ul>
<li>如果接收方是个合约则会调用它的receive或fallback函数，从而接收方可以回调发送方的函数</li>
<li>发送ether会因为调用栈深度超过1024导致失败。可以考虑使用<code>send</code>避免这个问题并检查<code>send</code>的返回值。更好的处理方式时为自身添加一个可以退款的方式</li>
</ul>
<h2 id="返回值校验"><a href="#返回值校验" class="headerlink" title="返回值校验"></a>返回值校验</h2><p>调用外部合约函数时，有些函数调用失败不会抛出错误回滚交易而是返回 false，如果忘记检查函数返回值会导致误以为调用成功。</p>
<p>例如：approve等方法就是不安全的，因此引入了safeApprove</p>
<p>当使用call方法调用approve时，如果没有校验返回值，则即使失败，也不会抛出异常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.8;</span><br><span class="line"></span><br><span class="line">contract ReturnValue &#123;</span><br><span class="line">  function callchecked(address callee) public &#123;</span><br><span class="line">    (bool success, ) = callee.call(&quot;&quot;);</span><br><span class="line">    require(success, &quot;call failed!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function callnotchecked(address callee) public &#123;</span><br><span class="line">    // 未校验</span><br><span class="line">    (bool success, ) = callee.call(&quot;&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="合约自杀式攻击"><a href="#合约自杀式攻击" class="headerlink" title="合约自杀式攻击"></a>合约自杀式攻击</h2><p>合约自杀时，会将合约自身持有的ether全部转入到指定地址之中。</p>
<p>如果某个合约使用了balance方法来进行校验时，有可能会出现攻击漏洞。</p>
<h3 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h3><p>规则如下：</p>
<ul>
<li>游戏的目标是成为第 7 个存入 1 个以太币的玩家。</li>
<li>玩家一次只能存入 1 个以太币。</li>
<li>获胜者将能够提取所有以太币。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract EtherGame &#123;</span><br><span class="line">    uint public targetAmount = 7 ether;</span><br><span class="line">    address public winner;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        require(msg.value,  &quot;You can only send 1 ether&quot;);</span><br><span class="line"></span><br><span class="line">        uint balance = address(this).balance;</span><br><span class="line">        require(balance &lt;= targetAmount, &quot;Game Over);</span><br><span class="line"></span><br><span class="line">        if(balance == targetAmount) &#123;</span><br><span class="line">            winner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function claimReward() public &#123;</span><br><span class="line">        require(msg.sender == winner, &quot;Not Winner&quot;);</span><br><span class="line">        (bool sent, ) = msg.sender.call&#123;value: address(this).balance&#125;(&quot;&quot;);</span><br><span class="line">        require(sent, &quot;Failed to send ether&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    EtherGame etherGame;</span><br><span class="line"></span><br><span class="line">    constructor(EtherGame _etherGame) &#123;</span><br><span class="line">        etherGame = EtherGame(_etherGame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public payable &#123;</span><br><span class="line">        // 不经过deposit使劲发送以太币使超过7个</span><br><span class="line"></span><br><span class="line">        //将address转化为payable</span><br><span class="line">        address payable addr = payable(address(etherGame));</span><br><span class="line">        selfdestruct(addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过程：</p>
<p>1.部署EtherGame<br>2. 玩家（比如爱丽丝和鲍勃）决定玩游戏，每人存入 1 个以太币。<br>3. 使用 EtherGame 地址部署攻击<br>4. 调用 Attack.attack 发送 5 个以太币。这会破坏游戏 没有人能成为赢家。</p>
<p>解决方案：</p>
<p>不使用balance进行校验。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract EtherGame &#123;</span><br><span class="line">    uint public targetAmount = 3 ether;</span><br><span class="line">    uint public balance;</span><br><span class="line">    address public winner;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        require(msg.value == 1 ether, &quot;You can only send 1 Ether&quot;);</span><br><span class="line"></span><br><span class="line">          // ！！通过状态变量来统计ether，此时即使合约自杀传入ether，也不会干扰条件判断逻辑！！</span><br><span class="line">        balance += msg.value;</span><br><span class="line"></span><br><span class="line">        require(balance &lt;= targetAmount, &quot;Game is over&quot;);</span><br><span class="line"></span><br><span class="line">        if (balance == targetAmount) &#123;</span><br><span class="line">            winner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function claimReward() public &#123;</span><br><span class="line">        require(msg.sender == winner, &quot;Not winner&quot;);</span><br><span class="line"></span><br><span class="line">        (bool sent, ) = msg.sender.call&#123;value: balance&#125;(&quot;&quot;);</span><br><span class="line">        require(sent, &quot;Failed to send Ether&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="访问私有数据private-data"><a href="#访问私有数据private-data" class="headerlink" title="访问私有数据private data"></a>访问私有数据private data</h2><p>所有链上的数据都可以被访问；不要把任何敏感信息存储在链上</p>
<p>private修饰符表示链上合约无法访问该数据，但是可以通过链下（读取slot的方式读取私有数据）</p>
<p>&#x2F;&#x2F; TODO: 未看代码验证</p>
<h2 id="tx-origin-攻击"><a href="#tx-origin-攻击" class="headerlink" title="tx.origin 攻击"></a><code>tx.origin</code> 攻击</h2><p>不要使用<code>tx.origin</code>进行鉴权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract TxUserWallet &#123;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferTo(address payable dest, uint amount) public &#123;</span><br><span class="line">        require(tx.origin == owner);</span><br><span class="line">        dest.transfer(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//现在有人欺骗你将以太币发送到这个攻击钱包的地址：</span><br><span class="line"></span><br><span class="line">interface TxUserWallet &#123;</span><br><span class="line">    function transferTo(address payable dest, uint amount) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TxAttackWallet &#123;</span><br><span class="line">    address payable owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = payable(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        TxUserWallet(msg.sender).transferTo(owner, msg.sender.balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果钱包检查了<code>msg.sender</code>以获得授权，它将获得攻击钱包的地址，而不是所有者的地址。但是通过检查 tx.origin，它得到了启动交易的原始地址，这仍然是所有者的地址。</p>
<h2 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h2><p>默认在checked模式下，溢出总是会回滚。如果无法避免溢出，则可能导致智能合约卡在某个状态。尝试使用<code>require</code>控制输入的范围。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/17/Solidity%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" data-id="cli5d2ofy000v0ohk0mdpbcrn" data-title="Solidity合约安全" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity面向对象" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/17/Solidity%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T02:01:02.000Z" itemprop="datePublished">2023-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/17/Solidity%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">Solidity面向对象</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="inheritance、virtual、override"><a href="#inheritance、virtual、override" class="headerlink" title="inheritance、virtual、override"></a>inheritance、virtual、override</h2><ol>
<li>合约之间存在继承关系，使用 <code>is</code></li>
<li>如果父合约的方法想被子合约继承则需要使用关键字 <code>virtual</code></li>
<li>如果子合约想要覆盖父合约的方法则需使用关键字 <code>override</code></li>
<li>在子合约中如果想调用父合约的方法需要使用 <code>super</code></li>
<li>继承遵循最远继承，即后面继承的合约会覆盖前面父合约的方法</li>
<li>super会调用继承链条上每一个合约的相关函数，而不仅仅是最近的父合约。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.10;</span><br><span class="line"></span><br><span class="line">/* Inheritance tree</span><br><span class="line">   A</span><br><span class="line"> /  \</span><br><span class="line">B   C</span><br><span class="line"> \ /</span><br><span class="line">  D</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">contract A &#123;</span><br><span class="line">	event Log(string message);</span><br><span class="line">	</span><br><span class="line">	function foo() public virtual &#123;</span><br><span class="line">		emit Log(&quot;A.foo called&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	function bar() public virtual &#123;</span><br><span class="line">		emit Log(&quot;A.bar called&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract B is A &#123;</span><br><span class="line">	function foo() public virtual override &#123;</span><br><span class="line">		emit Log(&quot;B.foo called&quot;);</span><br><span class="line">		A.foo();</span><br><span class="line">	&#125;</span><br><span class="line">	function bar() public virtual override &#123;</span><br><span class="line">		emit Log(&quot;B.bar called&quot;);</span><br><span class="line">		super.bar();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract C is A &#123;</span><br><span class="line">    function foo() public virtual override &#123;</span><br><span class="line">        emit Log(&quot;C.foo called&quot;);</span><br><span class="line">        A.foo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function bar() public virtual override &#123;</span><br><span class="line">        emit Log(&quot;C.bar called&quot;);</span><br><span class="line">        super.bar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract D is B, C &#123;</span><br><span class="line">    // Try:</span><br><span class="line">    // - Call D.foo and check the transaction logs.</span><br><span class="line">    //   Although D inherits A, B and C, it only called C and then A.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    function foo() public override(B, C) &#123;</span><br><span class="line">        super.foo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      // Try:</span><br><span class="line">    // - Call D.bar and check the transaction logs</span><br><span class="line">    //   D called C, then B, and finally A.</span><br><span class="line">    //   Although super was called twice (by B and C) it only called A once.</span><br><span class="line">    function bar() public override(B, C) &#123;</span><br><span class="line">        super.bar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>D调用foo的时候，由于B，C中的foo都没有使用super，所以只是覆盖问题，根据最远继承，C 覆盖了B，所以执行顺序为：D -&gt; C -&gt; A；</li>
<li>D调用bar的时候，由于B，C中的bar使用了super，此时D的两个parent都需要执行一遍，因此为D-&gt; C -&gt; B -&gt; A，整个过程中A合约只会被调用一次。具体原因是Solidity借鉴了Python的方式，强制一个由基类构成的DAG（有向无环图）使其保证一个特定的顺序。</li>
</ol>
<h2 id="继承的状态变量覆盖"><a href="#继承的状态变量覆盖" class="headerlink" title="继承的状态变量覆盖"></a>继承的状态变量覆盖</h2><ol>
<li>状态变量无法进行重写，只能继承父类状态变量</li>
<li>但是可以通过在子合约的构造函数中进行覆盖，从而达到重写目的</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract A &#123;</span><br><span class="line">    string public name = &quot;Contract A&quot;;</span><br><span class="line"></span><br><span class="line">    function getName() public view returns (string memory) &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Shadowing is disallowed in Solidity 0.6</span><br><span class="line">// This will not compile</span><br><span class="line">// contract B is A &#123;</span><br><span class="line">//     string public name = &quot;Contract B&quot;;</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">contract C is A &#123;</span><br><span class="line">    // This is the correct way to override inherited state variables.</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        name = &quot;Contract C&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // C.getName returns &quot;Contract C&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>在继承合约时如果父合约有构造函数则需要显示对父合约进行构造。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract X &#123;</span><br><span class="line">	string public name;</span><br><span class="line">	constructor(string memory _name) &#123;</span><br><span class="line">		name = _name;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Y &#123;</span><br><span class="line">	string public text;</span><br><span class="line">	</span><br><span class="line">	constructor(string memory _name) &#123;</span><br><span class="line">		text = _name;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 第一种初始化方式</span><br><span class="line">contract B is X(&quot;Input to X&quot;), Y(&quot;Input to Y&quot;) &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 构造顺序取决于继承顺序，从左到右，而不是实例化顺序</span><br><span class="line">// 第二种初始化方式</span><br><span class="line">contract D is X, Y &#123;</span><br><span class="line">	    constructor() X(&quot;X was called&quot;) Y(&quot;Y was called&quot;) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>抽象合约的作用是将函数定义和具体实现分离，从而实现解耦、可拓展性，其使用规则为：</p>
<ol>
<li>当合约中有未实现的函数时，则合约必须修饰为abstract；</li>
<li>当合约继承的base合约中有构造函数，但是当前合约并没有对其进行传参时，则必须修饰为abstract；</li>
<li>abstract合约中未实现的函数必须在子合约中实现，即所有在abstract中定义的函数都必须有实现；</li>
<li>abstract合约不能单独部署，必须被继承后才能部署；</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.6.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">abstract contract Animal &#123;</span><br><span class="line">    string public species;</span><br><span class="line">    constructor(string memory _base) &#123;</span><br><span class="line">        species = _base;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract contract Feline &#123;</span><br><span class="line">    uint public num;</span><br><span class="line">    function utterance() public pure virtual returns (bytes32);</span><br><span class="line"></span><br><span class="line">    function base(uint _num) public returns(uint, string memory) &#123;</span><br><span class="line">        num = _num;</span><br><span class="line">        return (num, &quot;hello world!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 由于Animal中的构造函数没有进行初始化，所以必须修饰为abstract</span><br><span class="line">abstract contract Cat1 is Feline, Animal &#123;</span><br><span class="line">    function utterance() public pure override returns (bytes32) &#123; </span><br><span class="line">      return &quot;miaow&quot;; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Cat2 is Feline, Animal(&quot;Animal&quot;) &#123;</span><br><span class="line">    function utterance() public pure override returns (bytes32) &#123; </span><br><span class="line">      return &quot;miaow&quot;; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h2><p>可以使用Interface完成多个合约之间进行交互，interface有如下特性：</p>
<ol>
<li>接口中定义的function不能存在具体实现；</li>
<li>接口可以继承；</li>
<li>所有的function必须定义为external；</li>
<li>接口中不能存在constructor函数；</li>
<li><strong>接口中不能定义状态变量。</strong></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/upstate-interactive/solidity-how-to-know-when-to-use-abstract-contracts-vs-interfaces-874cab860c56">abstract和interface的区别</a></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract Counter &#123;</span><br><span class="line">    uint public count;</span><br><span class="line"></span><br><span class="line">    function increment() external &#123;</span><br><span class="line">        count += 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IBase &#123;</span><br><span class="line">    function count() external view returns (uint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface ICounter is IBase &#123;</span><br><span class="line">    function increment() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract MyContract &#123;</span><br><span class="line">    function incrementCounter(address _counter) external &#123;</span><br><span class="line">        ICounter(_counter).increment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getCount(address _counter) external view returns (uint) &#123;</span><br><span class="line">        return ICounter(_counter).count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">uniswap demo:</span><br><span class="line"></span><br><span class="line">// Uniswap example</span><br><span class="line">interface UniswapV2Factory &#123;</span><br><span class="line">    function getPair(address tokenA, address tokenB)</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (address pair);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface UniswapV2Pair &#123;</span><br><span class="line">    function getReserves()</span><br><span class="line">        external</span><br><span class="line">        view</span><br><span class="line">        returns (</span><br><span class="line">            uint112 reserve0,</span><br><span class="line">            uint112 reserve1,</span><br><span class="line">            uint32 blockTimestampLast</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract UniswapExample &#123;</span><br><span class="line">    address private factory = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f;</span><br><span class="line">    address private dai = 0x6B175474E89094C44Da98b954EedeAC495271d0F;</span><br><span class="line">    address private weth = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;</span><br><span class="line"></span><br><span class="line">    function getTokenReserves() external view returns (uint, uint) &#123;</span><br><span class="line">        address pair = UniswapV2Factory(factory).getPair(dai, weth);</span><br><span class="line">        (uint reserve0, uint reserve1, ) = UniswapV2Pair(pair).getReserves();</span><br><span class="line">        return (reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/17/Solidity%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" data-id="cli5d2og100140ohk00x66jge" data-title="Solidity面向对象" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity事件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/17/Solidity%E4%BA%8B%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T01:59:15.000Z" itemprop="datePublished">2023-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/17/Solidity%E4%BA%8B%E4%BB%B6/">Solidity事件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>事件是区块链上的日志，每当用户发起操作的时候，可以发送相应的事件，常用于：</p>
<ol>
<li>监听用户对合约的调用</li>
<li>便宜的存储（用合约存储更加昂贵）</li>
</ol>
<p>通过链下程序（如：subgraph）对合约进行事件监听，可以对Event进行搜集整理，从而做好数据统计，常用方式：</p>
<ul>
<li>合约触发后发送事件</li>
<li>subgraph对合约事件进行监听，计算（如：统计用户数量）</li>
<li>前端程序直接访问subgraph的服务，获得统计数据（这避免了在合约层面统计数据的费用，并且获取速度更快）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract Event &#123;</span><br><span class="line">	event Log(address indexed sender, string message);</span><br><span class="line">	event AnotherLog();</span><br><span class="line">	event TestAnonymous(address indexed sender, uint256 num) anonymous; // 匿名事件</span><br><span class="line">	function test() public &#123;</span><br><span class="line">		emit Log(msg.sender,  &quot;Hello World&quot;);</span><br><span class="line">		emit Log(msg.sender, &quot;Hello EVM&quot;);</span><br><span class="line">		emit AnotherLog();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个事件内可以最多将三个字段修饰为indexed，当使用indexed关键字时，更加方便索引，并且：</p>
<ol>
<li>如果修饰的是值类型的，则直接展示；</li>
<li>如果是非值类型，如：array，string等，则使用keccak256哈希值。</li>
<li>indexed：方便索引</li>
<li>non-indexed：没有解码，需要使用abi解码后才知道内容，不加indexed是data</li>
</ol>
<p>其他：</p>
<ol>
<li>Log也在区块链账本中，和合约存储在不同的结构中；</li>
<li>Log是由交易执行产生的数据，它是不需要共识的，可以通过重新执行交易生成；</li>
<li>Log是经由链上校验的，无法造假，因为一笔交易的Receipt Hash是存在链上的（Header中）</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/17/Solidity%E4%BA%8B%E4%BB%B6/" data-id="cli5d2ofq00040ohk38cc8kdb" data-title="Solidity事件" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity以太币传输" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/17/Solidity%E4%BB%A5%E5%A4%AA%E5%B8%81%E4%BC%A0%E8%BE%93/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T01:57:43.000Z" itemprop="datePublished">2023-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/17/Solidity%E4%BB%A5%E5%A4%AA%E5%B8%81%E4%BC%A0%E8%BE%93/">Solidity以太币传输</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="发送方式"><a href="#发送方式" class="headerlink" title="发送方式"></a>发送方式</h2><ul>
<li><code>transfer()</code>：消耗2300gas，失败会抛出异常</li>
<li><code>send()</code>：消耗2300gas，返回表示成功状态的bool值，如果使用必须要校验是否执行成功</li>
<li><code>call()</code>: 传递交易剩余的gas或设置的gas，不限定2300gas，返回一个bool表明调用状态。<ul>
<li>通过调用fallback(下方例子，推荐)</li>
<li>通过调用receive(下方例子，推荐)</li>
</ul>
</li>
</ul>
<p>transfer与call使用2300gas以防止重入攻击，但公链升级后可能导致 gas 不足。所以推荐使用 call() 函数，但需做好防重入攻击准备。</p>
<p>只有当msg.data为空且目标合约具有receive函数才可以使用receive的方式进行转账，其他则为fallback方式。</p>
<h2 id="接收"><a href="#接收" class="headerlink" title="接收"></a>接收</h2><p>想接受ether的合约至少包含以下方法的一个：</p>
<ul>
<li><code>receive() external payable</code>: msg.data为空时调用</li>
<li><code>fallback() external payable</code>: msg.data非空时调用，为执行default逻辑而生，<strong>顺便支持接收ether</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract ReceiveEther &#123;</span><br><span class="line">    /*</span><br><span class="line">    Which function is called, fallback() or receive()?</span><br><span class="line"></span><br><span class="line">                sender ether</span><br><span class="line">                    |</span><br><span class="line">             msg.data is empty?</span><br><span class="line">                /       \</span><br><span class="line">            yes          no</span><br><span class="line">             /             \</span><br><span class="line">      receive() exist?     fallback()</span><br><span class="line">          /    \</span><br><span class="line">        yes     no</span><br><span class="line">       /          \</span><br><span class="line">  receive()     fallback()</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">    string public message;</span><br><span class="line"></span><br><span class="line">    // Function to receive Ether. msg.data must be empty</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        message = &quot;receive called!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Fallback function is called when msg.data is not empty</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        message = &quot;fallback called!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setMsg(string memory _msg) public &#123;</span><br><span class="line">        message = _msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SendEther &#123;</span><br><span class="line">    function sendViaTransfer(address payable _to) public payable &#123;</span><br><span class="line">        // This function is no longer recommended for sending Ether. (不建议使用)</span><br><span class="line">        _to.transfer(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendViaSend(address payable _to) public payable &#123;</span><br><span class="line">        // Send returns a boolean value indicating success or failure.</span><br><span class="line">        // This function is not recommended for sending Ether. (不建议使用)</span><br><span class="line">        bool sent = _to.send(msg.value);</span><br><span class="line">        require(sent, &quot;Failed to send Ether&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendViaCallFallback(address payable _to) public payable &#123;</span><br><span class="line">        // Call returns a boolean value indicating success or failure.</span><br><span class="line">        // This is the current recommended method to use. (推荐使用)</span><br><span class="line">        (bool sent, bytes memory data) = _to.call&#123;value: msg.value&#125;(abi.encodeWithSignature(&quot;noExistFuncTest()&quot;));</span><br><span class="line">        require(sent, &quot;Failed to send Ether&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendViaCallReceive(address payable _to) public payable &#123;</span><br><span class="line">        // Call returns a boolean value indicating success or failure.</span><br><span class="line">        // This is the current recommended method to use.(推荐使用)</span><br><span class="line">        (bool sent, bytes memory data) = _to.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(sent, &quot;Failed to send Ether&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/17/Solidity%E4%BB%A5%E5%A4%AA%E5%B8%81%E4%BC%A0%E8%BE%93/" data-id="cli5d2ofx000r0ohkespo78vk" data-title="Solidity以太币传输" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Solidity函数" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/16/Solidity%E5%87%BD%E6%95%B0/" class="article-date">
  <time class="dt-published" datetime="2023-05-16T10:31:17.000Z" itemprop="datePublished">2023-05-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/05/16/Solidity%E5%87%BD%E6%95%B0/">Solidity函数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Get-函数"><a href="#Get-函数" class="headerlink" title="Get 函数"></a>Get 函数</h2><p>编译器自动为public类型的状态变量创建Get函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.4.16 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint public data = 42;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Caller &#123;</span><br><span class="line">    C c = new C();</span><br><span class="line">    function f() public view returns (uint) &#123;</span><br><span class="line">        data = 3; // internal access</span><br><span class="line">        return this.data(); // external access</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自动生成的Get函数具有external属性。</p>
<p>如果是一个public的数组则只能通过get函数获取单个元素，其目的是防止返回整个数组导致消耗过多gas。</p>
<h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><p>装饰器例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.8.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">contract Owned &#123;</span><br><span class="line">    address payable owner;</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Only owner can call this function&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Destructible is Owned &#123;</span><br><span class="line">    function destroy() public onlyOwner &#123;</span><br><span class="line">        selfdestruct(owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Priced &#123;</span><br><span class="line">    // 接收参数</span><br><span class="line">    modifier costs(uint price) &#123;</span><br><span class="line">        if (msg.value &gt;= price) &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Register is priced, destructible &#123;</span><br><span class="line">    mapping(address =&gt; bool) registeredAddresses;</span><br><span class="line">    uint price;</span><br><span class="line"></span><br><span class="line">    constructor(uint initialPrice) &#123; price = initialPrice; &#125;</span><br><span class="line"></span><br><span class="line">    function register() public payable costs(price) &#123;</span><br><span class="line">        registeredAddresses[msg.sender] = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changePrice(uint price_) public onlyOwner &#123;</span><br><span class="line">        price = price_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Mutex &#123;</span><br><span class="line">    bool locked;</span><br><span class="line">    modifier noReentrancy() &#123;</span><br><span class="line">        require(</span><br><span class="line">            !locked,</span><br><span class="line">            &quot;Reentrant call.&quot;</span><br><span class="line">        );</span><br><span class="line">        locked = true;</span><br><span class="line">        _;</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function f() public noReentrancy returns (uint) &#123;</span><br><span class="line">        (bool success,) = msg.sender.call(&quot;&quot;);</span><br><span class="line">        require(success);</span><br><span class="line">        return 7;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对view与pure类型函数的一点说明"><a href="#对view与pure类型函数的一点说明" class="headerlink" title="对view与pure类型函数的一点说明"></a>对<code>view</code>与<code>pure</code>类型函数的一点说明</h2><p>下列情况被认为是修改状态:</p>
<ul>
<li>写入状态变量</li>
<li>触发事件</li>
<li>创建其他合约</li>
<li>使用<code>selfdestruct</code></li>
<li>通过调用发送以太币</li>
<li>调用没有被标记为<code>view</code>或<code>pure</code>的函数</li>
<li>使用底层调用</li>
<li>使用包含特定操作码的内联汇编</li>
</ul>
<p>下列情况被认为是读取状态</p>
<ul>
<li>读取状态变量</li>
<li>访问<code>address(this).balance</code>或<code>&lt;address&gt;.balance</code></li>
<li>访问<code>tx</code>、<code>block</code>等全局变量的成员(除<code>msg.sig</code>与<code>msg.data</code>外)</li>
<li>调用任何没有被标记为<code>pure</code>的函数</li>
<li>使用包含特定操作码的内联汇编</li>
</ul>
<h2 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h2><p>调用函数时，具体调用的函数信息会被拼装成calldata，calldata的前四个字节就是这个甘函数的selector，selector是这个函数的唯一标识。</p>
<p>通过拼接selector与函数形参可以在合约中得到calldata，并在合约中通过call的方式调用另外一个合约中的方法，从而实现合约间的调用。</p>
<h3 id="获取selector的方式"><a href="#获取selector的方式" class="headerlink" title="获取selector的方式"></a>获取selector的方式</h3><h4 id="使用abi-encodeWithSignature"><a href="#使用abi-encodeWithSignature" class="headerlink" title="使用abi.encodeWithSignature"></a>使用<code>abi.encodeWithSignature</code></h4><p>通过拼接selector与函数形参可以在合约中得到calldata，并在合约中通过call的方式调用另外一个合约中的方法，从而实现合约间的调用。</p>
<p>在一个合约中一个函数的4字节selector可以通过<code>abi.encodeWithSignature</code>获取。</p>
<p><strong>注意，其获取参数的方式时通过传入的字符串计算哈希，所以不可以有多余的空格等符号，形参也必须与原函数保持一致，uint256与uint也会导致不同的结果。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bytes memory transferSelector = abi.encodeWithSignature(&quot;transfer(address, uint256)&quot;);</span><br><span class="line"></span><br><span class="line">// 调用</span><br><span class="line">addr.call(transferSelector, 0xSomeAddress, 100);</span><br><span class="line"></span><br><span class="line">// 更函数式的写法</span><br><span class="line">addr.call(abi.encodeWithSignature(&quot;transfer(address, uint256)&quot;), 0xSomeAddress, 100);</span><br></pre></td></tr></table></figure>

<h4 id="keccak256"><a href="#keccak256" class="headerlink" title="keccak256"></a>keccak256</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 获取哈希时仅处理函数名和形参而不必考虑返回值</span><br><span class="line">bytes4(keccak256(bytes(&quot;transfer(address,uint256)&quot;)));</span><br></pre></td></tr></table></figure>

<h4 id="直接获取"><a href="#直接获取" class="headerlink" title="直接获取"></a>直接获取</h4><p>使用<code>this.transfer.selector</code></p>
<h4 id="使用abi-encodeCall方式"><a href="#使用abi-encodeCall方式" class="headerlink" title="使用abi.encodeCall方式"></a>使用<code>abi.encodeCall</code>方式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">interface IERC20 &#123;</span><br><span class="line">	function transfer(address, uint) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function encodeCall(address to, uint amount) external pure returns (bytes memory) &#123;</span><br><span class="line">	return abi.encodeCall(IERC20.transfer, (to, amount));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用外部合约中的函数"><a href="#调用外部合约中的函数" class="headerlink" title="调用外部合约中的函数"></a>调用外部合约中的函数</h2><p>合约间调用的方式主要包括：</p>
<ul>
<li>通过合约实例</li>
<li>使用call调用合约</li>
<li>使用delegate调用合约</li>
</ul>
<h3 id="call"><a href="#call" class="headerlink" title="call"></a>call</h3><p>call时一种底层调用合约的方式，可以在合约内调用其他合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(bool success, bytes memory data) = addr.call&#123;value: ValueAmt, gas: gasAmt&#125;(abi.encodeWithSignature(&quot;foo(string,uint256)&quot;), ...args);</span><br></pre></td></tr></table></figure>

<p>返回值：</p>
<ul>
<li><code>success</code>: 执行结果，必须要校验是否成功，失败务必要回滚</li>
<li><code>data</code>: 调用函数的返回值，是打包的字节序，需要重新解析才能得到原始返回值。</li>
</ul>
<p><strong>当调用fallback方式给合约转ether时建议使用call而不是transfer或send</strong></p>
<p>以下是通过fallback的方式转账</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(bool success, bytes memory data) = addr.call&#123;value: 10&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>

<p>注意，当调用的方法不存在，且合约又未实现fallback时，<strong>交易会调用成功，但是第一个参数为：false</strong>，所以使用call调用后一定要检查success状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(bool success, bytes memory data) = _addr.call(abi.encodeWithSignature(&quot;doesNotExist()&quot;));</span><br></pre></td></tr></table></figure>

<h3 id="delegatecall"><a href="#delegatecall" class="headerlink" title="delegatecall"></a>delegatecall</h3><p>当A合约通过delegatecall调用的B合约的函数时，使用的是A的上下文，包括A的状态变量，msg.value, msg.sender等。</p>
<p>因此使用delegatecall的前提是A、B具有相同的状态变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract Callee &#123;</span><br><span class="line">    uint public x;</span><br><span class="line">    uint public value;</span><br><span class="line"></span><br><span class="line">    function setX(uint _x) public returns (uint) &#123;</span><br><span class="line">        x = _x;</span><br><span class="line">        return x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setXandSendEther(uint _x) public payable returns (uint, uint) &#123;</span><br><span class="line">        x = _x;</span><br><span class="line">        value = msg.value;</span><br><span class="line"></span><br><span class="line">        return (x, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Caller &#123;</span><br><span class="line">    // 直接在参数中进行实例化合约</span><br><span class="line">    function setX(Callee _callee, uint _x) public &#123;</span><br><span class="line">        uint x = _callee.setX(_x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 传递地址，在内部实例化callee合约</span><br><span class="line">    function setXFromAddress(address _addr, uint _x) public &#123;</span><br><span class="line">        Callee callee = Callee(_addr);</span><br><span class="line">        callee.setX(_x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 调用方法，并转ether</span><br><span class="line">    function setXandSendEther(Callee _callee, uint _x) public payable &#123;</span><br><span class="line">        (uint x, uint value) = _callee.setXandSendEther&#123;value: msg.value&#125;(_x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="fallback机制"><a href="#fallback机制" class="headerlink" title="fallback机制"></a>fallback机制</h2><p>fallback可以理解为一个可选实现的函数接口，无参数，无返回值。</p>
<p>会被调用的情况：</p>
<ul>
<li>当被调用的方法不存在时fallback会被调用</li>
<li>当向合同转ether而合同不存在receive函数时</li>
<li>当向合同转ether但是msg.data不为空时，即使receive存在</li>
</ul>
<p>当使用transfer或者send转账时fallback的gaslimit限定为2300gas</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line">	event Log(uint gas);</span><br><span class="line">	</span><br><span class="line">	fallback() external payable &#123;</span><br><span class="line">		emit Log(gasLeft());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function getBalance() public view returns (uint) &#123;</span><br><span class="line">		return address(this).balance;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SendTOFallback &#123;</span><br><span class="line">	function transferToFallback(address payable _to) public payable &#123;</span><br><span class="line">		_to.transfer(msg.value);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function callFallback(address payable _to) public payable &#123;</span><br><span class="line">		        // Log event:  &quot;gas&quot;: &quot;6110&quot;</span><br><span class="line">        (bool sent, ) = _to.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(sent, &quot;Failed to send Ether&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	function callNoExistFunc(address payable _to) public payable &#123;</span><br><span class="line">        // call no exist funtion will call fallback by default </span><br><span class="line">        // Log event:  &quot;gas&quot;: &quot;5146&quot;</span><br><span class="line">        (bool sent, ) = _to.call&#123;value: msg.value&#125;(abi.encodeWithSignature(&quot;noExistFunc()&quot;));</span><br><span class="line">        require(sent, &quot;Failed to call&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><p>库与合约类似，限制：不能在库中定义状态变量，不能向库地址中转入ether；</p>
<p>库有两种存在形式：</p>
<ol>
<li>内嵌（embedded）：当库中所有的方法都是internal时，此时会将库代码内嵌在调用合约中，不会单独部署库合约；</li>
<li>链接（linked）：当库中含有external或public方法时，此时会单独将库合约部署，并在调用合约部署时链接link到库合约。<ol>
<li>可以复用的代码可以编写到库中，不同的调用	者可以linked到相同的库，因此会更加节约gas；</li>
<li>对于linked库合约，调用合约使用delegatecall进行调用，所以上下文为调用合约；</li>
<li>部署工具（如remix）会帮我们自动部署&amp;链接合约库。</li>
</ol>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.13;</span><br><span class="line"></span><br><span class="line">// 1. 只有internal方法，会内嵌到调用合约中</span><br><span class="line">library SafeMath &#123;</span><br><span class="line">    function add(uint x, uint y) internal pure returns (uint) &#123;</span><br><span class="line">        uint z = x + y;</span><br><span class="line">        require(z &gt;= x, &quot;uint overflow&quot;);</span><br><span class="line"></span><br><span class="line">        return z;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library Math &#123;</span><br><span class="line">    function sqrt(uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        if (y &gt; 3) &#123;</span><br><span class="line">            z = y;</span><br><span class="line">            uint x = y / 2 + 1;</span><br><span class="line">            while (x &lt; z) &#123;</span><br><span class="line">                z = x;</span><br><span class="line">                x = (y / x + x) / 2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (y != 0) &#123;</span><br><span class="line">            z = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // else z = 0 (default value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TestSafeMath &#123;</span><br><span class="line">      // 对uint类型增加SafeMath的方法，</span><br><span class="line">      // 1. 后续定义的uint变量就会自动绑定SafeMath提供的方法: uint x;</span><br><span class="line">      // 2. 这个变量会作为第一个参数传递给函数: x.add(y);</span><br><span class="line">// 注意</span><br><span class="line">    using SafeMath for uint;</span><br><span class="line">// 注意</span><br><span class="line">    uint public MAX_UINT = 2**256 - 1;</span><br><span class="line"></span><br><span class="line">      // 用法1：x.方法(y)</span><br><span class="line">    function testAdd(uint x, uint y) public pure returns (uint) &#123;</span><br><span class="line">        return x.add(y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      // 用法2：库.方法(x)</span><br><span class="line">    function testSquareRoot(uint x) public pure returns (uint) &#123;</span><br><span class="line">        return Math.sqrt(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2. 存在public方法时，会单独部署库合约，并且第一个参数是状态变量类型</span><br><span class="line">library Array &#123;</span><br><span class="line">      // 修改调用者状态变量的方式，第一个参数是状态变量本身</span><br><span class="line">    function remove(uint[] storage arr, uint index) public &#123;</span><br><span class="line">        // Move the last element into the place to delete</span><br><span class="line">        require(arr.length &gt; 0, &quot;Can&#x27;t remove from empty array&quot;);</span><br><span class="line">        arr[index] = arr[arr.length - 1];</span><br><span class="line">        arr.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TestArray &#123;</span><br><span class="line">// 注意</span><br><span class="line">    using Array for uint[];</span><br><span class="line">// 注意</span><br><span class="line">    uint[] public arr;</span><br><span class="line"></span><br><span class="line">    function testArrayRemove() public &#123;</span><br><span class="line">        for (uint i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            arr.push(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        arr.remove(1);</span><br><span class="line"></span><br><span class="line">        assert(arr.length == 2);</span><br><span class="line">        assert(arr[0] == 0);</span><br><span class="line">        assert(arr[1] == 2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="节约gas的一些技巧"><a href="#节约gas的一些技巧" class="headerlink" title="节约gas的一些技巧"></a>节约gas的一些技巧</h2><ul>
<li>使用calldata替换memory</li>
<li>将状态变量加载到memory中</li>
<li>使用++i替换i++</li>
<li>对变量进行缓存</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://newive.github.io/2023/05/16/Solidity%E5%87%BD%E6%95%B0/" data-id="cli5d2ofw000q0ohkagt10zzc" data-title="Solidity函数" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ERC721/" rel="tag">ERC721</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NFT/" rel="tag">NFT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Smart-Contract/" rel="tag">Smart Contract</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alchemy/" rel="tag">alchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openzeppelin/" rel="tag">openzeppelin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3js/" rel="tag">web3js</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ERC721/" style="font-size: 10px;">ERC721</a> <a href="/tags/NFT/" style="font-size: 13.33px;">NFT</a> <a href="/tags/Smart-Contract/" style="font-size: 20px;">Smart Contract</a> <a href="/tags/Solidity/" style="font-size: 16.67px;">Solidity</a> <a href="/tags/alchemy/" style="font-size: 10px;">alchemy</a> <a href="/tags/hardhat/" style="font-size: 13.33px;">hardhat</a> <a href="/tags/openzeppelin/" style="font-size: 10px;">openzeppelin</a> <a href="/tags/solidity/" style="font-size: 13.33px;">solidity</a> <a href="/tags/web3js/" style="font-size: 10px;">web3js</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/27/Openzeppelin%E7%AC%94%E8%AE%B0/">Openzeppelin笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/27/Hardhat%E7%AC%94%E8%AE%B0/">Hardhat笔记</a>
          </li>
        
          <li>
            <a href="/2023/05/25/ERC721%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%A0%B7%E4%BE%8B/">ERC721简易项目开发Demo</a>
          </li>
        
          <li>
            <a href="/2023/05/19/ERC721/">ERC721</a>
          </li>
        
          <li>
            <a href="/2023/05/17/Solidity%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">Solidity智能合约基本概念</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 NeWive<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>