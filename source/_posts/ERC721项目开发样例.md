---
title: ERC721简易项目开发Demo
date: 2023-05-25 23:11:11
tags:
- ERC721
- hardhat
- solidity
- alchemy
- web3js
---

## Overview

整个项目涉及以下几个部分：
- hardhat: 用于部署与测试合约
- web3js: 用于与合约交互
- alchemy: 提供apiKey以及部分常用的查询API
- solidity: 编写合约

## 项目框架

### 目录结构

- `contracts`: 合约源文件
- `test`: 合约测试脚本
- `scripts`: 部署以及合约交互脚本

### 配置

- `hardhat.config.ts`: hardhat 配置
- `config.json`: 其他配置

### 涉及第三方库

- `@openzeppelin/contracts`
- `hardhat`
- `@nomicfoundation/hardhat-toolbox`
- `@nomicfoundation/hardhat-chai-matchers`
- `chai`
- `web3`
- `@nomiclabs/hardhat-ethers`
- `ethers@^5.0.0`

## 配置文件

### `config.json`

```json
{
  "APIKey": "pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs",
  "privateKey": "0x48c5c054fee936c953864af7e879fa7fafec9648b4466d4e67e0d58d3d748f0a",
  "publicKey": "0x1f7D4B464dfde59A11A362ee8d094a6FA817f1ca",
  "alchemyHTTPURL": "https://eth-sepolia.g.alchemy.com/v2/pHSmq8kY4ofyRUyyOGM22pfGJIRw6VAs",
  "contractName": "NFT",
  "contractAddress": "",
  "networkName": "sepolia",
  "description": "A ERC721-NFT Demo of NeWive",
  "limit": 10
}

```

### `hardhat.config.ts`

```ts
import { HardhatUserConfig } from "hardhat/config";
import config from "./config.json";

// 引入插件
import "@nomicfoundation/hardhat-toolbox";
import "@nomiclabs/hardhat-ethers";
import "@nomicfoundation/hardhat-chai-matchers";

// 默认网络是localhost，无需额外配置
const hardhatUserConfig: HardhatUserConfig = {
    solidity: "0.8.18",
    networks: {
        "sepolia": {
            url: config.alchemyHTTPURL,
            accounts: [config.privateKey]
        }
    }
};

export default hardhatUserConfig;
```

### `package.json`

在`package.json`中添加以下命令：

```json
{
  "scripts": {
    "compile": "npx hardhat compile", // 编译
    "deploy-local": "npx hardhat run scripts/deploy.ts --network localhost", // 部署到本地测试网
    "deploy-sepolia": "npx hardhat run scripts/deploy.ts --network sepolia", // 部署到sepolia测试网
    "testnet": "npx hardhat node",  // 启动本地测试网
    "console": "npx hardhat console --network localhost"    // 启动hardhat命令行,
    "exec-local": "npx hardhat run --network localhost",
    "exec-sepolia": "npx hardhat run --network sepolia",
    "test": "npx hardhat test"
  }
}
```
## 合约部分

```solidity
// SPDX-License-Identifier: MIT

pragma solidity ^0.8.18;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract ERC721NFT is ERC721, ERC721Enumerable, ERC721URIStorage, Ownable {
    using Counters for Counters.Counter;

    Counters.Counter private _tokenIDCounter;
    uint256 private _tokenNumLimit;
    string private _description;

    event SafeMintReturnValue(uint256);

    constructor(uint256 tokenNumLimit, string memory description) ERC721("ERC721NFT", "Joy") {
        _tokenNumLimit = tokenNumLimit;
        _description = description;
    }

    function safeMint(address target, string memory tokenMetadataURI) public {
        require(_tokenIDCounter.current() <= _tokenNumLimit, "NFT number reaches the limit");
        uint256 tokenID = _tokenIDCounter.current();
        _tokenIDCounter.increment();
        _safeMint(target, tokenID);
        _setTokenURI(tokenID, tokenMetadataURI);
        emit SafeMintReturnValue(tokenID);
    }

    function setDescription(string memory description) public onlyOwner {
        _description = description;
    }

    // 以下为父类要求实现的接口

    function _beforeTokenTransfer(address from, address to, uint256 firstTokenID, uint batchSize) internal override(ERC721, ERC721Enumerable) {
        super._beforeTokenTransfer(from, to, firstTokenID, batchSize);
    }

    function _burn(uint256 tokenID) internal override(ERC721, ERC721URIStorage) {
        super._burn(tokenID);
    }

    function supportsInterface(bytes4 interfaceID) public view override(ERC721, ERC721Enumerable, ERC721URIStorage) returns (bool) {
        return super.supportsInterface(interfaceID);
    }

    function tokenURI(uint256 tokenID) public view override(ERC721, ERC721URIStorage) returns (string memory) {
        return super.tokenURI(tokenID);
    }
}
```

## hardhat 部署脚本

```ts
import hardhat from "hardhat";
import path from "path";
import fs from "fs/promises";
import {Config} from "./type";

const configPath = path.resolve("./config.json");

const defaultConfig = {
    "APIKey": "114514",
    "privateKey": "114514",
    "publicKey": "114514",
    "alchemyHTTPURL": "https://eth-sepolia.g.alchemy.com/v2/114514",
    "contractName": "NFT",
    "contractAddress": "",
    "networkName": "sepolia",
    "description": "A ERC721-NFT Demo of NeWive",
    "limit": 10
};

async function readConfig(): Promise<Config> {
    try {
        return JSON.parse((await fs.readFile(configPath)).toString()) as Config;
    } catch (e) {
        console.error(e);
        console.error(`采用默认配置: ${defaultConfig}`);
        return defaultConfig;
    }
}

async function updateContractAddress(config: Config, address: string) {
    try {
        config.contractAddress = address;
        await fs.writeFile(configPath, JSON.stringify(config));
        return true;
    } catch (e) {
        console.error(e);
        return false;
    }
}

async function deploy() {
    const config = await readConfig();
    const ERC721NFTContractFactory = await hardhat.ethers.getContractFactory("ERC721NFT");
    const contractInstance = await ERC721NFTContractFactory.deploy(config.limit, config.description);
    await contractInstance.deployed();
    console.log(`Contract deployed at address: ${contractInstance.address}, owner: ${await contractInstance.signer.getAddress()}`);
    if(await updateContractAddress(config, contractInstance.address)) {
        console.log("Contract address updated successfully");
    }
}

deploy()
    .then(() => {
        console.log("Deployed Succeeded");
    })
    .catch((e) => {
        console.error(e);
    });
```

完成后执行向本地测试网部署命令`npm run deploy-local`。

{% asset_img deploy_1.png Alchemy日志 %}

{% asset_img deploy_2.png Etherscan-Sepolia日志 %}

## 测试脚本

```
import hardhat from "hardhat";
import chai from "chai";
import config from "../config.json";
import {expect} from "chai";

describe("ERC721MFT", function () {
    before(async function () {
        this.Contract = await hardhat.ethers.getContractFactory("ERC721NFT");
    });
    
    beforeEach(async function () {
        try {
            this.contract = await this.Contract.deploy(config.limit, config.description);
            await this.contract.deployed();
            const signers = await hardhat.ethers.getSigners();
            this.owner = signers.splice(0,1)[0];
            this.collector = signers;
            this.mintCount = 3;
            this.tokenID = [];
            let p = [];
            for(let i = 0; i < this.mintCount; ++i) {
                p.push(this.contract.safeMint(this.collector[i].address, i.toString()));
                this.tokenID.push(i);
            }
            await Promise.all(p);
        } catch (e) {
            console.log(e);
            process.exit(1);
        }
    });
    
    it("Contract Name: ERC721", async function () {
        expect(await this.contract.name()).to.equal("ERC721NFT");
    });
    
    it('合约的Symbol为Joy', async function () {
        expect(await this.contract.symbol()).to.equal("Joy");
    });
    
    it("合约拥有者能正确对应", async function() {
        for(let i = 0; i < this.mintCount; ++i) {
            expect(await this.contract.ownerOf(this.tokenID[i])).to.equal(this.collector[i].address);
        }
    });
    
    it("可以遍历NFT个数", async function () {
        console.log(this.tokenID.length);
        expect((await this.contract.balanceOf(this.collector[0].address)).toString()).to.equal("1");
    });
    
    it("可以铸造新的NFT", async function () {
        const nTokenID = this.tokenID.length;
        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);
        expect(await this.contract.ownerOf(nTokenID)).to.equal(this.collector[nTokenID].address);
    });
    
    it("触发SafeMintReturnValue事件", async function () {
        const nTokenID = this.tokenID.length;
        await this.contract.safeMint(this.collector[nTokenID].address, nTokenID);
        expect(await this.contract.ownerOf(nTokenID))
            .to
            .emit(this.contract, "SafeMintReturnValue")
            .withArgs(nTokenID);
    });
    
    it("只能铸造一定次数的NFT", async function () {
        for(let i = 3; i <= 10; ++i) {
            await this.contract.safeMint(this.collector[i].address, i);
        }
        await expect(this.contract.safeMint(this.collector[11].address, "11"))
            .to
            .be
            .revertedWith("NFT number reaches the limit");
    });
    
    it('可以正确展示合约描述', async function () {
        expect(await this.contract.getDescription())
            .to
            .equal(config.description);
    });
    
    it("可以修改合约描述", async function () {
        await this.contract.setDescription("114514");
        expect(await this.contract.getDescription())
            .to
            .equal("114514");
    });
});
```

执行`npm run test`。

{% asset_img test_1.png 测试输出 %}

## 交互脚本

此处提供三种可选的交互方式，包括
- hardhat
- web3js
- alchemy-sdk

### 基于hardhat

```ts
// integrateByHardhat.ts
import hardhat from "hardhat";
import config from "../config.json";

async function integrateByHardhat() {
    // 链接合约
    const Contract = await hardhat.ethers.getContractFactory("ERC721NFT");
    const contract = await Contract.attach(config.contractAddress);
    
    // 合约信息
    const name = await contract.name();
    const symbol = await contract.symbol();
    const description = await contract.getDescription();
    console.log(`Contract name: ${name}, Contract symbol: ${symbol}, Description: ${description}`);
    
    // 用户信息
    const signers = await hardhat.ethers.getSigners();
    const owner = signers.splice(0, 1)[0];
    console.log(`Contract Owner: ${owner.address}`);
    const collectors = signers.map(i => i.address);
    console.log(`Contract Collectors: ${collectors.join(",")}`);
    
    // 铸币
    contract.once("SafeMintReturnValue", (tokenID) => {
       console.log(`铸币成功，tokenID为${tokenID}`);
    });
    const tx = (await contract.safeMint(owner.address, "ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF"));
    await tx.wait();
    
    // owner拥有的NFT数量
    const balanceOfOwner = await contract.balanceOf(owner.address);
    console.log(`The balance of the owner: ${balanceOfOwner}`);
    
    // 修改信息
    const tx1 = await contract.setDescription(`${new Date().toLocaleDateString()}`);
    await tx1.wait();
    const nDescription = await contract.getDescription();
    console.log(nDescription);
}

integrateByHardhat();
```

其中涉及修改链上状态的方法例如`safeMint`以及`setDescription`都需要使用wait等待交易被确认。
执行`npm run exec-sepolia ./scripts/integrateByHardhat.ts`。

{% asset_img hardhat_1.png hardhat输出 %}

### 基于web3js

```ts
import Web3 from "web3";
import config from "../config.json";
import contractArtifacts from "../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json";
import {AbiItem} from "web3-utils";
import {TransactionConfig, EventLog} from "web3-core";

async function integrateByWeb3() {
    // 将alchemyHTTP作为Provider传递给Web3
    const alchemy = new Web3(config.alchemyHTTPURL);
    // 添加一个钱包账号
    const account = alchemy.eth.accounts.wallet.add(config.privateKey);
    // 创建一个合约实例
    const contract = new alchemy.eth.Contract(contractArtifacts.abi as Array<AbiItem>, config.contractAddress);
    // 事件监听
    const safeMintEventListener = await contract
        .events
        .SafeMintReturnValue({
            filter: {},
            fromBlock: "latest"
        });
    
    // 创建交易， works
    // safeMintEventListener.on("data", (e:EventLog) => {
    //     console.log(e.returnValues);
    // });
    // safeMintEventListener.on("connected", function(subscriptionId: EventLog){
    //     console.log(subscriptionId);
    // });
    const gasPrice = await alchemy.eth.getGasPrice();
    const tx: TransactionConfig = {
        from: config.publicKey,
        to: config.contractAddress,
        gasPrice,
        nonce: await alchemy.eth.getTransactionCount(config.publicKey),
        data: contract.methods.safeMint(config.publicKey, "ipfs://1145141910811").encodeABI(),
        gas: 210000
    };
    // 发送交易，如果该交易是通过一个存在的账号发送则会自动签署
    const response = await alchemy.eth.sendTransaction(tx);
    console.log(response);
    
    // 通过签署交易然后发送
    console.log(await contract.methods.getDescription().call());
    const tx1: TransactionConfig = {
        from: config.publicKey,
        to: config.contractAddress,
        gasPrice,
        nonce: await alchemy.eth.getTransactionCount(config.publicKey),
        data: contract.methods.setDescription("你是一个一个一个").encodeABI(),
        gas: 210000
    }
    const signedTX = await account.signTransaction(tx1);
    const res1 = await alchemy.eth.sendSignedTransaction(signedTX.rawTransaction as string);
    console.log(res1);
    console.log(await contract.methods.getDescription().call());
    
    // Not Work, 只获取到返回值而sepolia etherscan中没有mint记录，call不会改变链上的状态
    // const tx = await contract.methods.safeMint(config.publicKey, "ipfs://1145141910811").call();
    // console.log(tx);
}

integrateByWeb3();
```

其中未解决发送交易调用函数的返回值与事件监听的问题。

### 基于alchemy-sdk

```ts
import {Network, Utils, Wallet, Alchemy} from "alchemy-sdk";
import config from "../config.json";
import contractArtifacts from "../artifacts/contracts/ERC721NFT.sol/ERC721NFT.json";
import {TransactionRequest} from "@ethersproject/providers";
import {ethers} from "ethers";

const settings = {
    apiKey: config.APIKey,
    network: Network.ETH_SEPOLIA
};

interface FunctionName {
    [key: string]: string;
}

const web3 = new Alchemy(settings);
const wallet = new Wallet(config.privateKey, web3);

async function integrateAlchemySDK() {
    // 获取给出地址的所有的NFT
    const allNFTs = await web3.nft.getNftsForOwner(config.publicKey);
    console.log(allNFTs);
    // // 根据tokenID获取Owner
    const owner = await web3.nft.getOwnersForNft(config.contractAddress, 0);
    console.log(owner);
    // // 根据合约获取所有owner
    const owners = await web3.nft.getOwnersForContract(config.contractAddress, {
        withTokenBalances: true
    });
    console.log(owners);
    
    // 调用会改变链上状态的方法
    // 解析ABI
    const contractInterface = new Utils.Interface(contractArtifacts.abi);
    const functionName: FunctionName = {};
    for (let k in contractInterface.functions) {
        if (Object.prototype.hasOwnProperty.call(contractInterface.functions, k)) {
            functionName[contractInterface.functions[k].name as string] = k;
        }
    }
    // 对方法进行ABI编码
    const safeMintEncoded = contractInterface.encodeFunctionData("safeMint", [config.publicKey, "ipfs://QmbUiW4nYKPzdXQB6nrpcAw4Ya7b1JmVQMekBcfCQAbRQF"])
    console.log(safeMintEncoded);
    // 获取nonce
    const nonce = await web3.core.getTransactionCount(
        wallet.address,
        "latest"
    );
    // 获取gasPrice，是必要的一步，不获取会抛出Transaction Underpriced错误
    const gasPrice = (await web3.core.getFeeData()).gasPrice;
    const transaction = {
        from: config.publicKey,
        to: config.contractAddress,
        gasLimit: 21000000,
        data: safeMintEncoded,
        nonce,
        gasPrice
    }
    const signedTransact = await wallet.signTransaction(transaction as TransactionRequest);
    const sentTX = await (await web3.core.sendTransaction(signedTransact)).wait();
    console.log(sentTX);
    // 获取事件日志
    const SafeMintReturnValue = contractInterface.encodeFilterTopics("SafeMintReturnValue", []);
    const logs = await web3.core.getLogs({
        toBlock: "latest",
        address: config.contractAddress,
        topics: SafeMintReturnValue
    });
    console.log("日志: ");
    console.log(logs[0].data);
    
    // call不能调用改变链上状态的方法
    const messageABIEncoded = contractInterface.encodeFunctionData("getDescription");
    const resHex = (await web3.core.call({
        from: config.publicKey,
        to: config.contractAddress,
        data: messageABIEncoded,
        nonce: await wallet.getTransactionCount()
    }));
    console.log(resHex);
    // 解析字符串
    console.log(ethers.utils.toUtf8String(resHex));
}

integrateAlchemySDK();
```